<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../bower_components/import-tinymce/import-tinymce.html">
<link rel="import" href="../../bower_components/polymer-mce/polymer-mce.html">
<link rel="import" href="../../bower_components/the-grid/the-grid.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">

<link rel="import" href="page-tile.html">
<link rel="import" href="../imports/imports-speakingurl.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="everest-page-create">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                --grid-width: 100%;
            }

            .material {
                background-color: #ffffff;
                color: #757575;
            }

            paper-input {
                width: 30%
            }

            paper-tabs {
                --paper-tabs-selection-bar-color: #179BD7;
            }

            paper-tab {
                --paper-tab-ink: #179BD7;
            }

            paper-tab[aria-selected=true] {
                color: #179BD7;
            }

            the-grid {
                margin: 16px 0;
                background: #f7f7f7;
                width: 100%;
                height: 100%;
            }

            the-grid > div[placeholder] {
                background: #afafaf;
            }
        </style>

        <!-- <firebase-query
            id="pages"
            path="/pages">
        </firebase-query>
        <firebase-document
            path="/users/[[user.uid]]"
            data="{{userData}}">
        </firebase-document> -->
        <div class="material">
            <h1>Create a new page</h1>
            <div class="section-header">
                <paper-input label="Title of the page" value="{{title}}"></paper-input>
                <div class="sub-align"><span>Publish</span>
                    <paper-toggle-button checked="{{published}}"></paper-toggle-button></div>
                <paper-button
                    class="save-button"
                    raised
                    on-tap="create">
                    <iron-icon icon="done"></iron-icon>Save</paper-button>
            </div>
            <paper-tabs selected="{{builderMode}}" attr-for-selected="name" fallback-selection="text">
                <paper-tab name="text">Text mode</paper-tab>
                <paper-tab name="grid">Grid mode</paper-tab>
            </paper-tabs>
            <iron-pages selected="{{builderMode}}" attr-for-selected="name">
                <section name="text">
                    <polymer-mce id="editor"
                        base-url="[[origin]]/bower_components/tinymce"
                        hidden$="[[!editMode]]"
                        tinytoolbar="insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"
                        tinyplugins='["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste"]'
                    ></polymer-mce>
                </section>
                <section id="grid" name="grid">
                    <div class="section-header">
                        <div>Column number : {{nbCol}} <paper-slider value="{{nbCol}}" min="5" max="12"></paper-slider></div>
                        <div>
                            <paper-button class="save-button" raised on-tap=addTile>ADD</paper-button>
                        </div>
                    </div>
                    <the-grid
                        draggable
                        resizable
                        animated
                        row-autogrow
                        col-count="{{nbCol}}"
                        row-count="{{nbRow}}"
                        cell-width="{{cellWidth}}"
                        cell-height="{{cellHeight}}"
                        cell-margin="12">

                        <template is="dom-repeat" items={{pageTiles}}
                            as=tile index-as=index initialCount=2>
                            <page-tile class="tile"
                                type="[[tile.type]]"
                                col$="[[tile.col]]"
                                row$="[[tile.row]]"
                                height$="[[tile.height]]"
                                width$="[[tile.width]]">

                                <span resize="left"></span>
                                <span resize="right"></span>
                                <span resize="top"></span>
                                <span resize="bottom"></span>
                                <span resize="top-right"></span>
                                <span resize="top-left"></span>
                                <span resize="bottom-right"></span>
                                <span resize="bottom-left"></span>
                            </page-tile>
                        </template>
                        <div placeholder></div>
                    </the-grid>
                </section>
                <section></section>
            </iron-pages>
        </div>
        <paper-toast id="stateMessage" horizontal-align="left" always-on-top duration="5000" text="" on-iron-overlay-closed="_toastClosed">
            <iron-icon id="toastIcon" class="validate-icon" icon$="[[stateMessageIcon]]"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'everest-page-create',

            properties: {
                title: {
                    type: String,
                    observer: '_titleChanged',
                },
                published: {
                    type: Boolean,
                },
                content: {
                    type: String,
                },

                user: {
                    type: Object
                },

                userData: {
                    type: Object
                },

                isAdmin: {
                    type: Boolean,
                    value: false,
                },

                editMode: {
                    type: Boolean,
                    value: true,
                },

                pageTiles: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                nbCol: {
                    type: Number,
                    value: 12,
                    obsever: '_computeCellWidth'
                },

                nbRow: {
                    type: Number,
                    value: 6
                },

                cellHeight: {
                    type: Number,
                    value: 100
                },

                cellWidth: {
                    type: Number,
                    value: 100
                },

                stateMessage: {
                    type: Object,
                    value: function () {
                        return {
                            'success': {
                                icon: "check-circle",
                                text: "Your changes have been saved!",
                            },
                            'errorExist': {
                                icon: "warning",
                                text: "Error! A page with this title already exists!",
                            },
                            'errorEmpty': {
                                icon: "warning",
                                text: "Error! You must give a title to your page!",
                            },
                            'errorCategory': {
                                icon: "warning",
                                text: "Error! You must assign a category to your article!",
                            },
                            'errorRight': {
                                icon: "warning",
                                text: "Error! You do not have the rights!",
                            },
                        }
                    }
                },
            },

            ready: function () {
                // Init the cumpute of the grid
                this._computeCellWidth();

                window.addEventListener('resize', this._computeCellWidth.bind(this));
            },

            addTile: function (e) {
                if (this.pageTiles.length >= this.nbRow-2) {
                    ++this.nbRow;
                }
                this.push('pageTiles', {
                    type: 'text',
                    col: 0,
                    row: this.pageTiles.length,
                    height: 1,
                    width: this.nbCol,
                });
            },

            create: function (e) {
                if (this.title && this.slug && this.$.editor.getContent() != "" && this.isAdmin) {
                    var _this = this;
                    this.$.pages.ref.push({
                        title: this.title || "",
                        slug: this.slug || "",
                        content: this.$.editor.getContent() || "",
                        created: Date.now(),
                        updated: Date.now(),
                        author: this.userData.basicInfo.name,
                        authorID: this.user.uid,
                        published: this.published,
                        trash: false,
                        'published_trash': this._computeCombinedIndexPt(),
                        'slug_published': this._computeCombinedIndexSp(),
                    }).then(function (value) {
                        _this.stateMessageIcon = _this.stateMessage.success.icon;
                        _this.$.stateMessage.text = _this.stateMessage.success.text;
                        _this.$.stateMessage.open();
                        _this.isUpdate = true;
                    }).catch(function (error) {
                        _this.stateMessageIcon = _this.stateMessage.errorRight.icon;
                        _this.$.stateMessage.text = _this.stateMessage.errorRight.text;
                        _this.$.stateMessage.open();
                    });
                } else {
                    _this.stateMessageIcon = _this.stateMessage.errorRight.icon;
                    _this.$.stateMessage.text = _this.stateMessage.errorRight.text;
                    _this.$.stateMessage.open();
                }
            },

            _computeCellWidth: function () {
                let initWidth = this.offsetWidth - (2*24 + 2* 16);
                this.cellHeight = (window.innerHeight - 12 * ( this.nbRow - 1)) / this.nbRow;
                this.cellWidth = (initWidth - 12 * ( this.nbCol - 1)) / this.nbCol;
            },

            _titleChanged: function (title) {
                this.slug = getSlug(title);
            },

            _toastClosed: function (e) {
                if (this.isUpdate) {
                    window.location.href = "/page/" + this.slug;
                }
            },

            _computeCombinedIndexPt: function () {
                return this.published
                    + "~" + "false";
            },

            _computeCombinedIndexSp: function () {
                return this.slug
                    + "~" + this.published;
            },
        });
    </script>
</dom-module>
