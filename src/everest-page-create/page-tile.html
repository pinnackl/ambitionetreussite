<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/iron-image/iron-image.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/iron-icons/editor-icons.html">

<link rel="import" href="../everest-wysiwyg/everest-wysiwyg.html">
<dom-module id="page-tile">
    <template>
        <style>
            :host {
                display: block;
                background: #fefefe;

                opacity: 0.9;
                cursor: move;
                box-sizing: border-box;
            }

            :host([edit]) {
                border: solid 3px #03a9f4;
            }

            :host(:not([edit])) ::slotted([resize]),
            :host(:not([edit])) .position,
            :host(:not([edit])) paper-fab {
                display: none;
            }

            :host([edit]:hover) .delete {
                display: block;
            }

            .delete {
                position: absolute;
                left: 8px;
                bottom: 8px;
                background: #e83b3b;
            }

            iron-pages {
                height: 100%;
            }

            iron-image {
                max-width: 100%;
                width: 100%;
                height: 100%;
            }

            .cover {
                background: #85ccec;
                color: #ffffff;
            }

            .position {
                position: absolute;
                top: 8px;
                right: 8px;
                color: #ffffff;
            }

            paper-fab {
                background: #179bd7;
                position: absolute;
                right: 8px;
                bottom: 8px;
            }

            [name] {
                max-height: 100%;
                height: 100%;
                overflow: hidden;
                box-sizing: border-box;
            } 

            [name=text] {
                padding: 16px;
            }

            div ::slotted([resize]) {
                position: absolute;
                display: block;
                width: 15px;
                height: 15px;
                bottom: 0;
                right: 0;
                border-radius: 50%;
                background-color: #03a9f4;
                border: solid thin #ffffff;
            }

            div ::slotted([resize="top"]),
            div ::slotted([resize="bottom"]) {
                left: 50%;
                -webkit-transform: translateX(-50%);
                transform: translateX(-50%);
            }

            div ::slotted([resize="bottom-right"]) {
                bottom: 0;
                right: 0;
                cursor: nwse-resize;
            }

            div ::slotted([resize="bottom-left"]) {
                bottom: 0;
                left: 0;
                cursor: nesw-resize;
            }

            div ::slotted([resize="top-right"]) {
                top: 0;
                right: 0;
                cursor: nesw-resize;
            }

            div ::slotted([resize="top-left"]) {
                top: 0;
                left: 0;
                cursor: nwse-resize;
            }

            div ::slotted([resize="left"]) {
                top: 50%;
                left: 0;
                cursor: ew-resize;
                margin-top: -10px;
            }

            div ::slotted([resize="top"]) {
                top: 0%;
                text-align: center;
                cursor: ns-resize;
            }

            div ::slotted([resize="right"]) {
                top: 50%;
                right: 0;
                cursor: ew-resize;
                margin-top: -10px;
            }

            div ::slotted([resize="bottom"]) {
                bottom: 0;
                text-align: center;
                cursor: ns-resize;
            }

            div ::slotted([resize="bottom-right"]) {
                -webkit-transform: translateX(8px) translateY(8px);
                transform: translateX(8px) translateY(8px);
            }

            div ::slotted([resize="bottom-left"]) {
                -webkit-transform: translateX(-8px) translateY(8px);
                transform: translateX(-8px) translateY(8px);
            }

            div ::slotted([resize="top-right"]) {
                -webkit-transform: translateX(8px) translateY(-8px);
                transform: translateX(8px) translateY(-8px);
            }

            div ::slotted([resize="top-left"]) {
                -webkit-transform: translateX(-8px) translateY(-8px);
                transform: translateX(-8px) translateY(-8px);
            }

            div ::slotted([resize="left"]) {
                -webkit-transform: translateX(-8px);
                transform: translateX(-8px);
            }

            div ::slotted([resize="top"]) {
                -webkit-transform: translateX(-50%) translateY(-8px);
                transform: translateX(-50%) translateY(-8px);
            }

            div ::slotted([resize="right"]) {
                -webkit-transform: translateX(8px);
                transform: translateX(8px)
            }

            div ::slotted([resize="bottom"]) {
                -webkit-transform: translateX(-50%) translateY(8px);
                transform: translateX(-50%) translateY(8px);
            }
        </style>
        <iron-pages selected="{{type}}" attr-for-selected="name">
            <div name="text">
                <template is="dom-if" if={{edit}}>
                    <everest-wysiwyg value="{{content.text}}" placeholder="Write some text ..."></everest-wysiwyg>
                </template>
                <div id="content" hidden="[[edit]]"></div>
            </div>
            <div name="image">
                <iron-image id="img" src$="[[content.image]]" placeholder="[[content.image]]" preload sizing="[[_ctnCover(content.cover)]]" position="[[content.position]]"></iron-image>
                <input id="inpt" type="file" style="display: none;" on-change="previewFile">
                <div class="position">
                    <paper-button class="cover" raised on-tap="_changeSizing">[[content.cover]]</paper-button>
                    <iron-icon icon="editor:vertical-align-[[content.position]]"></iron-icon>
                    <paper-menu-button>
                        <paper-icon-button icon="icons:open-with" slot="dropdown-trigger" horizontal-align="right"></paper-icon-button>
                        <paper-listbox slot="dropdown-content" selected="{{content.position}}" attr-for-selected="value" fallback-selection="center">
                            <paper-item value="top"><iron-icon icon="editor:vertical-align-top"></iron-icon>Top</paper-item>
                            <paper-item value="center"><iron-icon icon="editor:vertical-align-center"></iron-icon>Center</paper-item>
                            <paper-item value="bottom"><iron-icon icon="editor:vertical-align-bottom"></iron-icon>Bottom</paper-item>
                        </paper-listbox>
                    </paper-menu-button>
                </div>
                <paper-fab mini icon="file-upload" on-tap="_fileUpload"></paper-fab>
            </div>
        </iron-pages>
        <div><slot></slot></div>
        <paper-fab class="delete" mini icon="delete" on-tap="deleteTile"></paper-fab>
    </template>
    <script>
        Polymer({
            is: 'page-tile',

            properties: {
                edit: {
                    type: Boolean,
                    value: false
                },

                type: {
                    type: String
                },

                tile: {
                    type: Object,
                    notify: true,
                    observer: '_tileChanged'
                },

                text: {
                    type: String,
                    value: "",
                },

                col: {
                    type: Number,
                    notify: true
                },

                row: {
                    type: Number,
                    notify: true
                },

                height: {
                    type: Number,
                    notify: true
                },

                width: {
                    type: Number,
                    notify: true
                },

                content: {
                    type: Object,
                    value: function () {
                        return {};
                    }
                }

            },

            ready: function () {
            },

            _tileChanged: function (e) {
                if (this.type == "text") {
                    this.$.content.innerHTML = this.content.text;
                }
            },

            deleteTile: function (e) {
                this.fire('delete-tile', {tile: this.tile});
            },

            previewFile: function () {
                // FIXME : to test cross browser
                var file    = this.$.inpt.files[0];
                var reader  = new FileReader();

                reader.addEventListener("load", () => {
                    if (reader.result) {
                        this.set('content.image', reader.result);
                    }
                }, false);

                if (file) {
                    reader.readAsDataURL(file);
                }
            },

            _textChanged: function (text) {
                // this.set('content.text', text);
            },

            _ctnCover: function (cover) {
                if (!cover) { this.set('content.cover', 'cover'); }
                return this.content.cover;
            },

            _changeSizing: function (e) {
                let cover = this.content.cover == "cover" ? "contain" : "cover";
                this.set('content.cover', cover);
            },

            _fileUpload: function (e) {
                this.$.inpt.click();
            },
        });
    </script>
</dom-module>