<link rel="import" href="../ar-editor/ar-editor.html" async>
<script src="../../bower_components/node-uuid/uuid.js"></script>
<link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<dom-module id="ad-pages">
    <template>
        <style>
            :host {
                display: block;
                margin: 1em;
            }

            h1, h2 {
                letter-spacing: 0.1em;
            }

            h1 {
                font-weight: 600;
                font-size: 1em;
            }

            h2 {
                font-weight: 550;
                font-size: .9em;
            }

            a {
                text-decoration: none;
                color: #000;
            }

            iron-pages section {
                width: 100%;
                height: 80vh;
            }

            paper-button {
                background: #508FCA;
                color: #fff;
            }

            vaadin-grid {
                text-align: center;
            }

            .input-page-name paper-input {
                display: inline-block;
            }

            .ctnBtn {
                text-align: right;
                padding: 1em;
            }
            .pageNameBtn {
                padding-bottom: 1em;
            }

            #stateMessage {
                width: 30vw;
            }

            .validate-icon {
                color: #4CAF50;
            }
        </style>

        <app-route
            route="[[route]]"
            pattern="/:action"
            data="{{routeData}}"
            tail="{{subroute}}"></app-route>
        <app-route
            route="{{subroute}}"
            pattern="/:id"
            data="{{surouteData}}"></app-route>

        <h1>Gérer les pages [[page]]</h1>
        <iron-pages selected="[[page]]" attr-for-selected="name">
            <section name="list">
                <firebase-query
                    id="query"
                    path="/pages"
                    data="{{pageList}}">
                </firebase-query>
                <h2>Liste des pages</h2>
                <paper-material elevation="3">
                    <vaadin-grid id="pageListTable">
                        <table>
                            <colgroup>
                                <col name="UUID"/>
                                <col name="pageName"/>
                                <col name="edit"/>
                                <col name="delete"/>
                            </colgroup>
                            <tbody>
                                <template is="dom-repeat" items={{pageList}} 
                                    as=item index-as=index>
                                    <tr>
                                        <td>[[item.$key]]</td>
                                        <td>[[item.pageName]]</td>
                                        <td>
                                            <a href$="/nimda/pages/edit/[[item.$key]]" tabindex="-1"
                                                style="text-decoration:none;
                                                    color:#fff;">
                                                <paper-button class="btn-edit" raised
                                                    style="background:#508FCA;">
                                                    <iron-icon icon="create"></iron-icon>EDIT</paper-button>
                                            </a>
                                        </td>
                                        <td>
                                            <paper-button class="btn-delete"
                                                style="background:#ff1A1A;
                                                    color:#ffffff;" raised>
                                                <iron-icon icon="delete"></iron-icon>DELETE</paper-button>
                                        </td>
                                    </tr>
                                </template>
                            </tbody>
                        </table>
                    </vaadin-grid>
                </paper-material>
            </section>
            <section name="add">
                <firebase-document
                  path="/pages"
                  data="{{data}}">
                </firebase-document>
                <h2>Ajouter une nouvelle page</h2>
                <div class="input-page-name pageNameBtn">
                    <paper-input
                        id="pageNameInputAdd"
                        label="Page Name"
                        placeholder="Entrez le nom de la page"
                        value=""></paper-input>
                    <paper-button raised on-tap="createPage">ADD</paper-button>
                </div>
                <ar-editor id="editor" elevation="3" value=""></ar-editor>
                <div class="ctnBtn">
                    <paper-button raised on-tap="createPage">ADD</paper-button>
                </div>
            </section>
            <section name="edit">
                <firebase-document
                  path="/pages/[[id]]"
                  data="{{document}}">
                </firebase-document>
                <h2>Modifier une page : [[document.pageName]]</h2>
                <div class="input-page-name pageNameBtn">
                    <paper-input
                        id="pageNameInputEdit"
                        label="Page Name"
                        placeholder="[[document.pageName]]"
                        value="[[document.pageName]]"></paper-input>
                    <paper-button raised on-tap="updatePage">SAVE</paper-button>
                </div>
                <ar-editor id="editor" elevation="3" value="[[document.content]]"></ar-editor>
                <div class="ctnBtn">
                    <paper-button raised on-tap="updatePage">SAVE</paper-button>
                </div>
            </section>
        </iron-pages>
        <paper-toast id="stateMessage" horizontal-align="right" always-on-top duration="3000" text="Plop is the new Plop!">
            <iron-icon class="validate-icon" icon="check-circle"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'ad-pages',

            properties: {

                route: {
                    type: Object
                },

                page: {
                    type: String
                },

                data: {
                    type: Object,
                    observer: '_dataChanged'
                },

                document: {
                    type: Object,
                    observer: '_documentChanged'
                },

                isUpdate: {
                    type: Boolean,
                    value: false
                },

            },

            observers: [
                '_routePageChanged(routeData.action)',
                '_routeIdChanged(surouteData.id)',
            ],

            listeners: {
                'sort-order-changed': '_sortOrderChanged'
            },

            createPage: function () {
                this.set('data.' + uuid.v4(), {pageName: this.$.pageNameInputAdd.value, content: this.$.editor.getValue()});
                this.isUpdate = true;
                this.$.stateMessage.text = "Contenu créé avec succès!";
            },

            updatePage: function () {
                this.set('document', {pageName: this.$.pageNameInputEdit.value, content: this.$.editor.getValue()});
                this.isUpdate = true;
                this.$.stateMessage.text = "Vos modifications ont été sauvegardées!";
            },

            _routePageChanged: function (action) {
                console.log(action);
                this.page = action || 'list';
            },

            _routeIdChanged: function (id) {
                this.id = id || null;
            },

            _dataChanged: function (data) {
                if (data && this.isUpdate) {
                    this.$.stateMessage.open();
                    this.isUpdate = false;
                }
            },

            _documentChanged: function (e) {
                // this.$.saveMessage.open();
            }
        });
    </script>
</dom-module>