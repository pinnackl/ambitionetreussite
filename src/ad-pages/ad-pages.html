<link rel="import" href="../ar-editor/ar-editor.html" async>
<script src="../../bower_components/node-uuid/uuid.js"></script>
<!-- <link rel="import" href="../../bower_components/vaadin-grid/vaadin-grid.html"> -->
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../ar-grid/ar-grid.html">
<dom-module id="ad-pages">
    <template>
        <style>
            :host {
                display: block;
                margin: 1em;
            }

            h1, h2 {
                letter-spacing: 0.1em;
            }

            h1 {
                font-weight: 600;
                font-size: 1em;
            }

            h2 {
                font-weight: 550;
                font-size: .9em;
            }

            a {
                text-decoration: none;
                color: #000;
            }

            iron-pages section {
                width: 100%;
                height: 80vh;
            }

            .section-header {
                display: flex;
                flex-wrap: nowrap;
                justify-content: space-between;
                margin-bottom: 1em;
                align-items: center;
            }

            paper-button {
                background: #508FCA;
                color: #fff;
            }

            vaadin-grid {
                text-align: center;
            }

            .ctnBtn {
                text-align: right;
                padding: 1em 0;
            }

            #stateMessage {
                width: 30vw;
            }

            .validate-icon {
                color: #4CAF50;
            }
        </style>

        <app-route
            route="[[route]]"
            pattern="/:action"
            data="{{routeData}}"
            tail="{{subroute}}"></app-route>
        <app-route
            route="{{subroute}}"
            pattern="/:id"
            data="{{surouteData}}"></app-route>

        <h1>Gérer les pages</h1>
        <iron-pages selected="[[page]]" attr-for-selected="name">
            <section name="list">
                <firebase-query
                    id="query"
                    path="/pages"
                    data="{{pageList}}">
                </firebase-query>
                <div class="section-header">
                    <h2>Liste des pages</h2>
                    <a href="/nimda/pages/add" title="AJOUTER">
                        <paper-button raised>AJOUTER</paper-button>
                    </a>
                </div>
                <ar-grid
                    header="{{gridHeader}}"
                    data="[[pageList]]"
                    path="nimda/pages"
                    edit
                    delete></ar-grid>
            </section>
            <section name="add">
                <firebase-document
                  path="/pages"
                  data="{{data}}">
                </firebase-document>
                <h2>Ajouter une nouvelle page</h2>
                <div class="section-header">
                    <paper-input
                        id="pageNameInputAdd"
                        label="Page Name"
                        placeholder="Entrez le nom de la page"
                        value=""></paper-input>
                    <paper-button raised on-tap="createPage">VALIDER</paper-button>
                </div>
                <ar-editor id="editor" elevation="3" value=""></ar-editor>
                <div class="ctnBtn">
                    <paper-button raised on-tap="createPage">VALIDER</paper-button>
                </div>
            </section>
            <section name="edit">
                <firebase-document
                  path="/pages/[[id]]"
                  data="{{document}}">
                </firebase-document>
                <h2>Modifier une page : [[document.pageName]]</h2>
                <div class="section-header">
                    <paper-input
                        id="pageNameInputEdit"
                        label="Page Name"
                        placeholder="[[document.pageName]]"
                        value="[[document.pageName]]"></paper-input>
                    <paper-button raised on-tap="updatePage">VALIDER</paper-button>
                </div>
                <ar-editor id="editor" elevation="3" value="[[document.content]]"></ar-editor>
                <div class="ctnBtn">
                    <paper-button raised on-tap="updatePage">VALIDER</paper-button>
                </div>
            </section>
        </iron-pages>
        <paper-toast id="stateMessage" horizontal-align="right" always-on-top duration="3000" text="">
            <iron-icon class="validate-icon" icon="check-circle"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'ad-pages',

            properties: {

                route: {
                    type: Object
                },

                page: {
                    type: String
                },

                pageList: {
                    type: Array,
                    observer: '_pageListChanged'
                },

                data: {
                    type: Object,
                    observer: '_dataChanged'
                },

                document: {
                    type: Object,
                    observer: '_documentChanged'
                },

                isUpdate: {
                    type: Boolean,
                    value: false
                },

            },

            observers: [
                '_routePageChanged(routeData.action)',
                '_routeIdChanged(surouteData.id)',
            ],

            listeners: {
                'sort-order-changed': '_sortOrderChanged'
            },

            ready: function () {
                this.gridHeader = [
                    {name: "Nom", key: "pageName"},
                    {name: "Auteur", key: ""}
                ];
            },

            createPage: function () {
                this.set('data.' + uuid.v4(), {pageName: this.$.pageNameInputAdd.value, content: this.$.editor.getValue()});
                this.isUpdate = true;
                this.$.stateMessage.text = "Contenu créé avec succès!";
            },

            updatePage: function () {
                this.set('document', {pageName: this.$.pageNameInputEdit.value, content: this.$.editor.getValue()});
                this.isUpdate = true;
                this.$.stateMessage.text = "Vos modifications ont été sauvegardées!";
            },

            _routePageChanged: function (action) {
                this.page = action || 'list';
            },

            _routeIdChanged: function (id) {
                this.id = id || null;
            },

            _pageListChanged: function (pageList) {
                console.log(pageList);
            },

            _dataChanged: function (data) {
                if (data && this.isUpdate) {
                    this.$.stateMessage.open();
                    this.isUpdate = false;
                }
            },

            _documentChanged: function (e) {
            }
        });
    </script>
</dom-module>