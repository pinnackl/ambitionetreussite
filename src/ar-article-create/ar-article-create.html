<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-icons/social-icons.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/social-media-icons/social-media-icons.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-badge/paper-badge.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../bower_components/import-tinymce/import-tinymce.html">
<link rel="import" href="../../bower_components/polymer-tinymce/polymer-tinymce.html">
<link rel="import" href="../../bower_components/file-upload/file-upload.html">

<link rel="import" href="../imports/imports-moment.html">
<link rel="import" href="../imports/imports-speakingurl.html">

<link rel="import" href="../shared-styles.html">
<dom-module id="ar-article-create">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
                height: 100%;
            }

            .post .cover {
                position: relative;
                width: 100%;
                height: 60vh;
            }

            .post .cover iron-image {
                width: 100%;
                height: 100%;
            }

            .post .filter {
                position: absolute;
                top: 0;
                left: 0;
                z-index: 1;
                width : 100%;
                height: 100%;
                color: #ffffff;
                font-weight: 400;
                font-size: 12px;
                background-color: rgba(0,0,0,0);
                background-image: -webkit-linear-gradient(rgba(0,0,0,0.4) 0%,rgba(0,0,0,.4) 75%,rgba(0,0,0,.4) 100%); 
                background-image: linear-gradient(rgba(0,0,0,0.4) 0%,rgba(0,0,0,.4) 75%,rgba(0,0,0,.4) 100%);
                display: flex;
                flex-direction: column;
                flex-wrap: nowrap;
                justify-content: center;
                align-items: center;
            }

            .post .filter h1.title {
                color: #f7f7f7;
                font-size: 47px;
                line-height: 52px;
                width: 80%;
                text-align: center;
                text-transform: none;
                letter-spacing: 0px;
            }

            .post .filter .article-info {
                display: block;
                width: 90%;
                margin: 20px 0;
                font-size: 20px;

                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: row;
                -ms-flex-direction: row;
                flex-direction: row;
                -webkit-flex-wrap: nowrap;
                -ms-flex-wrap: nowrap;
                flex-wrap: nowrap;
                -webkit-justify-content: flex-start;
                -ms-flex-pack: start;
                justify-content: flex-start;
                -webkit-align-content: stretch;
                -ms-flex-line-pack: stretch;
                align-content: stretch;
                -webkit-align-items: center;
                -ms-flex-align: center;
                align-items: center;

            }

            .post .filter .article-info .avatar-ctn,
            .post .material.footer .comment .avatar-ctn {
                width: 64px;
                height: 64px;
                min-width: 64px;
                min-height: 64px;
                border-radius: 100%;
                overflow: hidden;
                display: inline-block;
                vertical-align: middle;
            }
            
            .post .filter .article-info .author-ctn,
            .post .material.footer .comment .author-ctn {
                display: inline-block;
                vertical-align: middle;
                padding-left: 12px;
            }
            
            .post .filter .article-info .social {
                /*height: 64px;*/
                padding: 0 8px;
                text-align: right;
                box-sizing: border-box;
                z-index: 1;
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 1 1 auto;
                -ms-flex: 1 1 auto;
                flex: 1 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }

            .post .secton-header {
            }

            .post .filter .article-info .autor-name a {
                text-decoration: none;
                color: #f7f7f7;
            }

            .post .material.footer .comment a {
                text-decoration: none;
                color: #56585c;
            }

            .post .filter .article-info .autor-name a:hover,
            .post .material.footer .comment a:hover {
                text-decoration: underline;
            }

            .post .filter .article-info .published {
                font-size: 0.6em;
            }

            .post .filter .article-info .category {
                /*height: 64px;*/
                padding-left: 12px;
                vertical-align: middle;
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 1 1 auto;
                -ms-flex: 1 1 auto;
                flex: 1 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }

            .post .filter .article-info .category a.tag {
                display: inline-block;
                background-color: #3eb7e9;
                color: #ffffff;
                text-align: center;
                text-decoration: none;
                padding: 2px 5px;
                border-radius: 2px;
                box-sizing: border-box;
            }

            .post .filter .article-info .category .tag:hover {
                background-color: #3eb7e9;
            }

            .post .filter .avatar-ctn iron-image.avatar,
            .post .footer .comment .author .avatar-ctn iron-image.avatar {
                width: 64px;
                height: 64px;
            }

            .sub-align {
                display: flex;
                justify-content: center;
                align-items: center;
                color: #737373;
            }
            
            .sub-align span {
                margin-right: 8px;
            }
            
            .sub-align paper-toggle-button {
                --paper-toggle-button-checked-button-color: #3eb7e9;
            }

            .post .material.content {
                position: relative;
                background-color: #ffffff;
                color: #444444;
                max-width: 1000px;
                margin-left: auto;
                margin-right: auto;
                z-index: 3;
                -moz-transform: translateY(-100px);
                -webkit-transform: translateY(-100px);
                -o-transform: translateY(-100px);
                -ms-transform: translateY(-100px);
                transform: translateY(-100px);
            }
            
            .post .material.content article .section-header {
                text-align: right;
            }

            .post .material.footer {
                min-height: 128px;
                margin: 0;
            }

            .post .material.footer h2 {
                color: #56585c;
            }

            .post .material.footer h2 .icon {
                padding-right: 12px;
            }

            .post .material.footer:before {
                display: block;
                content: '';
                width: 30%;
                border-bottom: solid 1px #56585c
            }

            .post .material.footer .social paper-button {
                color: #ffffff;
            }
            
            .post .material.footer .social paper-button a {
                display: inline-block;
                color: #ffffff;
                text-decoration: none;
            }

            .post .material.footer .social paper-button.facebook {
                background-color: #3B5998;
            }
            
            .post .material.footer .social paper-button.facebook social-media-icons {
                margin-right: 8px;
                vertical-align: middle;
            }

            .post .material.footer .comment .material {
                background-color: #F7F7F7;
                min-height: 128px;
                margin: 0 0 12px 0;
            }
            
            .post .material.footer .comment .material .comment {
                margin-top: 8px;
            }

            .post .material.footer .comment .material .published {
                font-size: 0.6em;
            }

            .post .material.footer .comment .avatar-ctn {
                display: inline-block;
            }

            .post .material paper-menu {
                height: 144px;
                background-color: #f7F7F7;
                overflow-y: scroll;
                padding: 0 6px;
            }

            .post .material paper-menu paper-item {
                cursor: pointer;
            }

            .post .material paper-menu paper-item.iron-selected {
                background-color: #179BD7;
                color: #ffffff;
            }

            .post .material.footer .tags {
                margin-top: 20px;
            }

            .post .material.footer .tags .tag {
                display: inline-block;
                background-color: #56585c;
                color: #ffffff;
                font-size: 1em;
                font-weight: 400;
                text-align: center;
                text-decoration: none;
                padding: 2px 5px;
                border-radius: 2px;
                box-sizing: border-box;
            }

            .post .material.footer .tags .tag:hover {
                background-color: #3eb7e9;
            }

            .save-button {
                background-color: #179BD7;
                color: #FFFFFF;
            }

            #stateMessage {
                width: 40vw;
            }

            .validate-icon[icon="check-circle"] {
                color: #4CAF50;
            }

            .validate-icon[icon="warning"] {
                color: #ff5252;
            }

            [spinner] {
                width: 100%;
                height: 100%;
            }

            /* Mobil */
            @media (max-width: 799px) {
                .post .material {
                    margin-top: 0;
                }

                .post .filter h1.title {
                    font-size: 27px;
                }

                .post .material.content {
                    -moz-transform: translateY(0px);
                    -webkit-transform: translateY(0px);
                    -o-transform: translateY(0px);
                    -ms-transform: translateY(0px);
                    transform: translateY(0px);
                }
            }
        </style>

        <firebase-document
            id="article"
            path="/articles"
            data="{{article}}">
        </firebase-document>
        <firebase-document
            path="/users/[[user.uid]]"
            data="{{userData}}">
        </firebase-document>
        <firebase-query
            id="categories"
            path="/categories"
            data="{{categories}}">
        </firebase-query>
        <firebase-query
            id="tags"
            path="/tags"
            data="{{tags}}">
        </firebase-query>

        <div class="post">
            <div class="cover">
                <iron-image src$="https://cdn.pinnackl.com/images/[[cover]]" preload style="background: #3eb7e9;" fade sizing="cover"></iron-image>
                <div class="filter">
                    <h1 class="title">[[title]]</h1> 
                    <div class="article-info">
                        <div class="avatar-ctn">
                            <iron-image class="avatar" src="https://cdn.pinnackl.com/avatar/[[userData.basicInfo.avatar]]" preload sizing="cover" style="background-color: lightgray;"></iron-image>
                        </div>
                        <div class="author-ctn">
                            <div class="autor-name">Par <a href="/user/[[user.uid]]" title="[[userData.basicInfo.name]]">[[userData.basicInfo.name]]</a>,</div>
                        </div>
                        <div class="category">
                            <a class="tag" href="#" title="[[_ucfirst(category)]]">[[_ucfirst(category)]]</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="material content">
                <h1>Créer un nouvel article</h1>
                <!-- Edit content -->
                <template is="dom-if" if={{editMode}}>
                    <div class="edit">
                        <div class="section-header">
                            <paper-input
                                id="articleTitle"
                                label="Titre"
                                value="{{title}}"></paper-input>
                            <div class="sub-align"><span>Publier</span>
                                <paper-toggle-button checked="{{published}}"></paper-toggle-button></div>
                            <paper-button
                                class="save-button"
                                raised
                                on-tap="create">
                                <iron-icon icon="done"></iron-icon>Créer</paper-button>
                        </div>
                        <div class="section-header">
                            <!-- FIXME : Get the target from config -->
                            <file-upload
                                droppable="true"
                                raised="true"
                                accept="image/*"
                                method="POST"
                                file-data-name="cover"
                                target="https://cdn.pinnackl.com/api/images/upload"
                                on-success="fileUploaded">Choisir une couverture</file-upload>
                            <paper-dropdown-menu label="Choisir une catégorie" value="{{category}}">
                                <paper-listbox class="dropdown-content">
                                    <template is="dom-repeat" items={{categories}} 
                                        as=item index-as=index>
                                        <paper-item>[[item.name]]</paper-item>
                                    </template>
                                </paper-listbox>
                            </paper-dropdown-menu>
                            <paper-input
                                label="Créer une nouvelle catégorie"
                                value="{{newCategory}}"></paper-input>
                            <paper-button raised class="save-button" on-tap="addCategory">Ajouter</paper-button>
                        </div>
                    </div>
                </template>
                <polymer-tinymce id="editor"
                    base-url="[[origin]]/bower_components/tinymce"
                    hidden$="[[!editMode]]"
                    tinytoolbar="insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image" 
                    tinyplugins='["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste"]'
                ></polymer-tinymce>

                <article id="content"></article>
                <div class="material footer">
                    <div class="material">
                        <h3>Choisir des tags</h3>
                        <div class="section-header">
                            <paper-input label="Créer un nouveau tag" value="{{newTag}}"></paper-input>
                            <paper-button raised class="save-button" on-tap="addTag">Ajouter</paper-button>
                        </div>
                        <paper-menu multi attr-for-selected="name" selected-values="{{selectedTags}}">
                            <template is="dom-repeat" items={{tags}} 
                                as=item index-as=index>
                                <paper-item name="[[item.name]]">[[item.name]]</paper-item>
                            </template>
                        </paper-menu>
                    </div>
                    <div class="tags">
                        <template is="dom-repeat" items={{selectedTags}} 
                            as=item index-as=index>
                            <a class="tag" href="#">[[item]]</a>
                        </template>
                    </div>
                </div>
                <div class="section-header">
                    <span></span>
                    <paper-button
                        class="save-button"
                        raised
                        on-tap="create">
                        <iron-icon icon="done"></iron-icon>Créer</paper-button>
                </div>
            </div>
        </div>
        <paper-toast id="stateMessage" horizontal-align="left" always-on-top duration="5000" text="" on-iron-overlay-closed="_toastClosed">
            <iron-icon id="toastIcon" class="validate-icon" icon$="[[stateMessageIcon]]"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'ar-article-create',

            properties: {
                user: {
                    type: Object,
                },

                article: {
                    type: Object
                },

                isAdmin: {
                    type: Boolean,
                    value: true,
                },

                isUpdate: {
                    type: Boolean,
                    value: false,
                },

                editMode: {
                    type: Boolean,
                    value: true,
                },

                origin: String,

                stateMessageIcon: {
                    type: String,
                    value: "check-circle"
                },

                stateMessage: {
                    type: Object,
                    value: function () {
                        return {
                            'success': {
                                icon: "check-circle",
                                text: "Vos modifications ont été sauvegardées!",
                            },
                            'errorExist': {
                                icon: "warning",
                                text: "Erreur! Un article avec ce titre existe déjà!",
                            },
                            'errorEmpty': {
                                icon: "warning",
                                text: "Erreur! Vous devez donner un titre à votre article!",
                            },
                            'errorCategory': {
                                icon: "warning",
                                text: "Erreur! Vous devez attribuer une catégorie à votre article!",
                            },
                            'errorRight': {
                                icon: "warning",
                                text: "Erreur! Vous n'avez pas les droits!",
                            },
                        } 
                    }
                },

                title: {
                    type: String,
                    observer: '_titleChanged',
                },

                slug: {
                    type: String,
                },

                category: {
                    type: String
                },

                categories: {
                    type: Array,
                    observer: '_categoriesChanged'
                },

                tags: {
                    type: Array
                },
            },

            ready: function () {
                this.origin = window.location.origin;
            },

            create: function (e) {
                this.isUpdate = false;
                if (this.slug != "" && typeof this.category != "undefined" && this.article.slug != this.slug) {
                    var _this = this;
                    this.$.article.ref.push({
                        slug: this.slug,
                        title: this.title || "",
                        category: this._lowerCase(this.category) || "",
                        cover: this.cover || "",
                        tags: this.selectedTags || [],
                        content: this.$.editor.getContent() || "",
                        created: Date.now(),
                        edited: Date.now(),
                        author: this.userData.basicInfo.name,
                        authorID: this.user.uid,
                        comments: [],
                        published: this.published,
                        trash: false,
                        'published_trash': this._computeCombinedIndexPt(),
                        'category_published_trash': this._computeCombinedIndexCpt(),
                    }).then(function (value) {
                        _this.stateMessageIcon = _this.stateMessage.success.icon;
                        _this.$.stateMessage.text = _this.stateMessage.success.text;
                        _this.$.stateMessage.open();
                        _this.isUpdate = true;
                    }).catch(function (error) {
                        _this.stateMessageIcon = _this.stateMessage.errorExist.icon;
                        _this.$.stateMessage.text = _this.stateMessage.errorExist.text;
                        _this.$.stateMessage.open();
                    });
                } else if (this.slug != "" && this.article.slug == this.slug) {
                    this.stateMessageIcon = this.stateMessage.errorExist.icon;
                    this.$.stateMessage.text = this.stateMessage.errorExist.text;
                    this.$.stateMessage.open();
                } else if (this.slug != "" && this.category != "undefined") {
                    this.stateMessageIcon = this.stateMessage.errorCategory.icon;
                    this.$.stateMessage.text = this.stateMessage.errorCategory.text;
                    this.$.stateMessage.open();
                } else if (this.slug == "") {
                    this.stateMessageIcon = this.stateMessage.errorEmpty.icon;
                    this.$.stateMessage.text = this.stateMessage.errorEmpty.text;
                    this.$.stateMessage.open();
                } else {
                    this.stateMessageIcon = this.stateMessage.errorRight.icon;
                    this.$.stateMessage.text = this.stateMessage.errorRight.text;
                    this.$.stateMessage.open();
                }
            },

            fileUploaded: function (e, detail) {
                var parsedResponse = JSON.parse(detail.xhr.response);
                this.cover = parsedResponse.name;
            },

            addTag: function (e) {
                if (this.newTag) {
                    this.$.tags.ref.push({
                        slug: getSlug(this.newTag),
                        name: this.newTag
                    });
                }
                this.newTag = null;
            },

            addCategory: function (e) {
                if (this.newCategory) {
                    this.$.categories.ref.push({
                        slug: getSlug(this.newCategory),
                        name: this.newCategory
                    });
                }
                this.newCategory = null;
            },

            _titleChanged: function (title) {
                this.slug = getSlug(title);
            },

            _categoriesChanged: function (categories) {
                
            },

            _toastClosed: function (e) {
                if (this.isUpdate) {
                    window.location.href = "/lire/" + getSlug(this.category) + "/" + this.slug;
                }
            },

            _computeCombinedIndexCpt: function () {
                return this._lowerCase(this.category)
                    + "~" + this.published
                    + "~" + "false";
            },

            _computeCombinedIndexPt: function () {
                return this.published
                    + "~" + "false";
            },

            _ucfirst: function (string) {
                if (string) {
                    return string.charAt(0).toUpperCase() + string.slice(1);
                }
                return '';
            },

            _lowerCase: function (string) {
                if (string) {
                    return string.toLowerCase();
                }
                return string;
            }
        });
    </script>
</dom-module>