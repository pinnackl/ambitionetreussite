<link rel="import" href="../../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/web-animations-js/web-animations-next-lite.min.html">
<!--<link rel="import" href="../../bower_components/file-upload/file-upload.html">-->
<link rel="import" href="../../bower_components/vaadin-upload/vaadin-upload.html">
<link rel="import" href="../../bower_components/paper-slider/paper-slider.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<dom-module id="everest-swatch-picker">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-icon-button {
        color: var(--swatch-picker-bg);
      }

      paper-swatch-picker {
        --paper-swatch-picker-icon: {
          color: white;
        }
      }

      file-upload {
        --paper-button: {
          border-radius: 100%;
          width: 56px;
          height: 56px;
          min-width: 56px;
          background: black;
          color: white;
          margin-bottom: 0px!important;
        }
      }

      .swatch-picker {
        display: inline-block;
        border-radius: 50%;
        background-color: var(--swatch-picker-bg);
      }

       [hidden] {
         display: none;
       }
    </style>
    <template is="dom-if" if="[[isCSS]]">
      <template is="dom-if" if="[[isColor]]">
        <div class="color">
          <div class="swatch-picker">
            <paper-swatch-picker color="{{color}}" noink horizontal-align="right"></paper-swatch-picker>
          </div>
        </div>
      </template>
      <template is="dom-if" if="[[!isColor]]">
        <template is="dom-if" if="[[isNumber]]">
          <paper-slider value="50" editable ></paper-slider>
        </template>
        <template is="dom-if" if="[[!isNumber]]">
          <paper-toggle-button noink></paper-toggle-button>
        </template>
      </template>
    </template>
    <template is="dom-if" if="[[!isCSS]]">
      <div class="image">
        <!--<file-upload
          accept="image/*"
          method="POST"
          file-data-name="cover"
          hide-file-list
          target="https://cdn.pinnackl.com/api/images/upload"
          on-success="_imageChanged">
          <iron-icon icon="cloud-upload"></iron-icon>
        </file-upload>-->
        <vaadin-upload 
          nodrop 
          max-files="1" 
          accept="image/*" 
          method="POST" 
          form-data-name="cover" 
          target="http://localhost:3000/upload" 
          on-upload-success="_imageChanged">
        </vaadin-upload>
      </div>
    </template>
  </template>
  <script>
    Polymer({
      is: 'everest-swatch-picker',

      properties: {
        color: {
          type: String,
          notify: true
        },

        image: {
          type: String,
          notify: true
        },

        mode: {
          type: String
        },

        category: {
          type: String
        },

        type: {
          type: String
        },

        asBackground: {
          type: Boolean,
          value: false
        }
      },

      observers: [
        '_modeChanged(mode)',
        '_categoryChanged(category)',
        '_typeChanged(type)',
        '__colorChanged(color)'
      ],

      _imageChanged: function(e, detail) {
        var cdn = "https://cdn.pinnackl.com/images/";
        var parsedResponse = JSON.parse(detail.xhr.response);
        var image = cdn + parsedResponse.name;
        if(this.asBackground)
          this.set('image', 'url("'+ image +'")');
        else
          this.set('image', image);
        console.log(this.image);
      },

      _modeChanged: function (mode) {
        this.isCSS = mode == "css" ? true : false;
      },

      _categoryChanged: function (category) {
        this.isColor = category == "color" ? true : false;
      },

      _typeChanged: function (type) {
        this.isNumber = type == "number" ? true : false;
      },

      // Only triggered when the swatch picker changed
      __colorChanged: function (value) {
        if (!value) {
          value = "#fefefe";
        }
        this.updateStyles({'--swatch-picker-bg' : this.__invertColor(value)});
      },

      __invertColor: function (hex) {
          if (hex.indexOf('#') === 0) {
              hex = hex.slice(1);
          }
          // convert 3-digit hex to 6-digits.
          if (hex.length === 3) {
              hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
          }
          if (hex.length !== 6) {
              throw new Error('Invalid HEX color.');
          }
          // invert color components
          var r = (255 - parseInt(hex.slice(0, 2), 16)).toString(16),
              g = (255 - parseInt(hex.slice(2, 4), 16)).toString(16),
              b = (255 - parseInt(hex.slice(4, 6), 16)).toString(16);
          // pad each with zeros and return
          return '#' + this.__padZero(r) + this.__padZero(g) + this.__padZero(b);
      },

      __padZero: function (str, len) {
          len = len || 2;
          var zeros = new Array(len).join('0');
          return (zeros + str).slice(-len);
      }
    });
  </script>
</dom-module>
