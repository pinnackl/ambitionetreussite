<link rel="import" href="../../bower_components/paper-swatch-picker/paper-swatch-picker.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">


<dom-module id="everest-swatch-picker">
  <template>
    <style>
      :host {
        display: block;
      }

      paper-icon-button {
        color: var(--swatch-picker-bg);
      }

      paper-swatch-picker {
        --paper-swatch-picker-icon: {
          color: white;
        }
      }

      file-upload {
        --paper-button: {
          border-radius: 100%;
          width: 56px;
          height: 56px;
          min-width: 56px;
          background: black;
          color: white;
          margin-bottom: 0px!important;
        }
      }

      .swatch-picker {
        display: inline-block;
        border-radius: 50%;
        background-color: var(--swatch-picker-bg);
      }

       [hidden] {
         display: none;
       }
    </style>
    <template is="dom-if" if="[[option]]">
      <div class="color">
        <div class="swatch-picker">
          <paper-swatch-picker color="{{color}}" noink horizontal-align="right"></paper-swatch-picker>
        </div>
      </div>
    </template>
    <template is="dom-if" if="[[!option]]">
      <div class="image">
        <file-upload
            accept="image/*"
            method="POST"
            file-data-name="cover"
            target="https://cdn.pinnackl.com/api/images/upload"
            on-success="_imageChanged">
            <iron-icon icon="cloud-upload"></iron-icon>
          </file-upload>
      </div>
    </template>
  </template>
  <script>
    Polymer({
      is: 'everest-swatch-picker',

      properties: {
        color: {
          type: String,
          notify: true
        },

        image: {
          type: String,
          notify: true
        },

        mode: {
          type: String
        }
      },

      observers: [
        '_modeChanded(mode)',
        '__colorChanged(color)'
      ],

      _imageChanged: function(e, detail) {
        var cdn = "https://cdn.pinnackl.com/images/";
        var parsedResponse = JSON.parse(detail.xhr.response);
        var image = cdn + parsedResponse.name;
        this.set('image', 'url("'+ image +'")');
        console.log(this.image);

        this._showDownload();
      },

      _modeChanded: function (mode) {
        this.option = mode == "color" ? true : false;
      },

      // Only triggered when the swatch picker changed
      __colorChanged: function (value) {
        if (!value) {
          value = "#fefefe";
        }
        this.customStyle['--swatch-picker-bg'] = this.__invertColor(value);
        this.updateStyles();
      },

      __invertColor: function (hex) {
          if (hex.indexOf('#') === 0) {
              hex = hex.slice(1);
          }
          // convert 3-digit hex to 6-digits.
          if (hex.length === 3) {
              hex = hex[0] + hex[0] + hex[1] + hex[1] + hex[2] + hex[2];
          }
          if (hex.length !== 6) {
              throw new Error('Invalid HEX color.');
          }
          // invert color components
          var r = (255 - parseInt(hex.slice(0, 2), 16)).toString(16),
              g = (255 - parseInt(hex.slice(2, 4), 16)).toString(16),
              b = (255 - parseInt(hex.slice(4, 6), 16)).toString(16);
          // pad each with zeros and return
          return '#' + this.__padZero(r) + this.__padZero(g) + this.__padZero(b);
      },

      __padZero: function (str, len) {
          len = len || 2;
          var zeros = new Array(len).join('0');
          return (zeros + str).slice(-len);
      }
    });
  </script>
</dom-module>
