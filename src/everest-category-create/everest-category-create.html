<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="../shared-styles.html">
<link rel="import" href="../imports/imports-speakingurl.html">
<dom-module id="everest-category-create">
    <template>
        <style include="shared-styles">
             :host {
                display: block;
            }
            
            .material {
                background-color: #ffffff;
            }
            
            paper-input {
                width: 30%
            }
            
            .categories {
                height: 291px;
                overflow-y: scroll;
                background-color: #f7f7f7;
            }
            
            .categories li.category {
                list-style: none;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin: 3px 0;
            }
        </style>
        <horizon-query id="categories" path="/categories" data="{{categories}}">
        </horizon-query>
        <div class="material">
            <h1>Manage categories</h1>
            <div class="section-header">
                <paper-input label="Add a new category" value="{{newCategory}}"></paper-input>
                <paper-button raised class="save-button" on-tap="addCategory">Add</paper-button>
            </div>
            <ul class="categories">
                <template is="dom-repeat" items={{categories}} as=item index-as=index>
                    <li class="category">
                        <span>[[item.name]]</span>
                        <paper-button raised category="[[item]]" class="delete-button" on-tap="removeCategory">Delete</paper-button>
                    </li>
                </template>
            </ul>
        </div>
        <paper-toast id="stateMessage" horizontal-align="left" always-on-top duration="5000" text="" on-iron-overlay-closed="_toastClosed">
            <iron-icon id="toastIcon" class="validate-icon" icon$="[[stateMessageIcon]]"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'everest-category-create',

            properties: {
                categories: {
                    type: Object
                },

                isAdmin: {
                    type: Boolean,
                    value: false,
                },

                stateMessage: {
                    type: Object,
                    value: function () {
                        return {
                            'success': {
                                icon: "check-circle",
                                text: "Your changes have been saved!",
                            },
                            'errorExist': {
                                icon: "warning",
                                text: "Error! A category with this title already exists!",
                            },
                            'errorEmpty': {
                                icon: "warning",
                                text: "Error! You must give a title to your category!",
                            },
                            'errorCategory': {
                                icon: "warning",
                                text: "Error! You must assign a category to your article!",
                            },
                            'errorRight': {
                                icon: "warning",
                                text: "Error! You do not have the rights!",
                            },
                        }
                    }
                }
            },

            addCategory: function (e) {
                if (this.newCategory && this.isAdmin) {
                    var _this = this;
                    const newRef = window.horizon('categories');
                    newRef.store({
                        slug: getSlug(this.newCategory),
                        name: this.newCategory
                    }).subscribe(function (value) {
                        _this.stateMessageIcon = _this.stateMessage.success.icon;
                        _this.$.stateMessage.text = _this.stateMessage.success.text;
                        _this.$.stateMessage.open();
                        _this.newCategory = null;
                    }, function (error) {
                        _this.stateMessageIcon = _this.stateMessage.errorRight.icon;
                        _this.$.stateMessage.text = _this.stateMessage.errorRight.text;
                        _this.$.stateMessage.open();
                    });
                }
            },

            removeCategory: function (e) {
                var key = e.currentTarget.category.id;
                var _this = this;
                const newRef = window.horizon('categories');
                newRef.remove(key).subscribe(
                    function (value) {
                        _this.stateMessageIcon = _this.stateMessage.success.icon;
                        _this.$.stateMessage.text = _this.stateMessage.success.text;
                        _this.$.stateMessage.open();
                    }, function (error) {
                        _this.stateMessageIcon = _this.stateMessage.errorRight.icon;
                        _this.$.stateMessage.text = _this.stateMessage.errorRight.text;
                        _this.$.stateMessage.open();
                    });
            },

            _toastClosed: function (e) {
            }
        });
    </script>
</dom-module>