<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer-dragula/polymer-dragula.html">
<link rel="import" href="../../bower_components/polymer-dragula/polymer-dragula-styles.html">
<link rel="import" href="../../bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="ar-footer">
    <template>
        <style include="shared-styles polymer-dragula-styles">
            :host {
                display: block;
            }

            .section-header-nw {
                display: flex;
                flex-wrap: nowrap;
                justify-content: space-between;
                margin-bottom: 1em;
                align-items: center;
            }

            .app-grid {
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: row;
                -ms-flex-direction: row;
                flex-direction: row;
                -webkit-flex-wrap: nowrap;
                -ms-flex-wrap: nowrap;
                flex-wrap: nowrap;
                -webkit-justify-content: space-around;
                -ms-flex-pack: distribute;
                justify-content: space-around;
                -webkit-align-content: stretch;
                -ms-flex-line-pack: stretch;
                align-content: stretch;
                -webkit-align-items: stretch;
                -ms-flex-align: stretch;
                align-items: stretch;
                padding-top: 0px;
                padding-left: 0px;
                box-sizing: border-box;
            }

            .end {
                background-color: #f8f8f8;
            }

            .footer {
                min-height: 30vh;
            }

            .end.footer {
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: column;
                -ms-flex-direction: column;
                flex-direction: column;
                -webkit-flex-wrap: nowrap;
                -ms-flex-wrap: nowrap;
                flex-wrap: nowrap;
                -webkit-justify-content: center;
                -ms-flex-pack: center;
                justify-content: center;
                -webkit-align-content: stretch;
                -ms-flex-line-pack: stretch;
                align-content: stretch;
                -webkit-align-items: stretch;
                -ms-flex-align: stretch;
                align-items: stretch;
            }
            
            .end.footer > polymer-dragula {
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 1 1 auto;
                -ms-flex: 1 1 auto;
                flex: 1 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }
            
            .end.footer > .end.right {
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 0 1 auto;
                -ms-flex: 0 1 auto;
                flex: 0 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }

            .item {
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 1 1 auto;
                -ms-flex: 1 1 auto;
                flex: 1 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto
            }

            .item.edit {
                padding: 3px;
                min-height: 30vh;
                background-color: #F1F1F1;
                border: dotted 3px #fbc009;
                margin: 0 3px;
                cursor: pointer;

                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                user-select: none !important;
            }

            .right {
                text-align: center;
                vertical-align: middle;
                font-weight: bold;
                font-size: 12px;
                line-height: 24px;
                color: #757575;
            }

            .right iron-icon {
                height: 18px;
                vertical-align: middle; 
            }

            .item .footer-cln-header {
                padding-left: 35px; 
                font-weight: bold;
                font-size: 12px;
                line-height: 24px;
                color: #179BD7;
            }

            .item ul, .item li {
                list-style: none;
            }

            .item li a {
                color: #757575;
                font-size: 12px;
                text-decoration: none;
                line-height: 24px;
            }

            .item li .github {
                vertical-align: middle;
                width: 2em;
                height: 2em;
            }

            .item li .social {
                line-height: 24px;
            }

            .gu-mirror {
                position: fixed !important;
                margin: 0 !important;
                z-index: 9999 !important;
                opacity: 0.8;
                -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=80)";
                filter: alpha(opacity=80);
                cursor: grabbing;
                cursor: -moz-grabbing;
                cursor: -webkit-grabbing;
            }

            .gu-hide {
                display: none !important;
            }

            .gu-unselectable {
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                user-select: none !important;
            }

            .gu-transit {
                background-color: rgba(23, 155, 215, 0.23)!important;
                border: dotted 3px #757575!important;
                opacity: 0.2;
                -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=20)";
                filter: alpha(opacity=20);
            }

            .footer-add-input {
                padding: 16px;
            }

            .add-link-button {
                --paper-menu-button-dropdown: {
                    width: 400px;
                    margin-bottom: 30px;
                }
            }

            .section-header paper-icon-button {
                color: #444444
            }

            .sublist paper-item {
              padding-left: 30px;
            }

            @media (max-width: 799px) {
                .app-grid {
                    -webkit-flex-direction: column;
                    -ms-flex-direction: column;
                    flex-direction: column;
                }
            }
        </style>

        <firebase-query
            id="footer"
            path="/footer"
            data="{{footer}}">
        </firebase-query>

        <firebase-query
            path="/pages"
            data="{{pagesData}}">
        </firebase-query>
        <firebase-query
            path="/categories"
            data="{{categoriesData}}">
        </firebase-query>
        <firebase-query
            path="/articles"
            data="{{articlesData}}">
        </firebase-query>
        <div class="end footer">
            <template is="dom-if" if={{isAdmin}}>
                <div class="footer-add-input section-header">
                    <div class="section-header">
                        <paper-input label="Ajouter une colonne" hidden$="[[!editMode]]" value="{{columnTitle}}"></paper-input>
                        <paper-button class="save-button" raised hidden$="[[!editMode]]" on-tap="addColumn">Ajouter</paper-button>
                    </div>
                    <template is="dom-if" if={{editMode}}>
                        <paper-button
                            class="save-button"
                            raised
                            on-tap="saveFooter">
                            <iron-icon icon="done"></iron-icon>Valider</paper-button>
                    </template>
                    <paper-icon-button icon="create" raised on-tap="edit"
                        hidden$="[[editMode]]"></paper-icon-button>
                    <paper-icon-button icon="close" raised on-tap="close"
                        hidden$="[[!editMode]]"></paper-icon-button>
                </div>
            </template>
            <polymer-dragula direction="horizontal" fn-moves="[[fnMovesInner]]" copy-sort-source>
                <div class="app-grid">
                    <template is="dom-repeat" items=[[footer]] 
                        as=column index-as=index sort="_sortFooter">
                        <div class$="item [[editClass]]" column="[[column]]" idx="[[index]]">
                            <div class="footer-cln-header section-header">
                                <div>
                                    <template is="dom-if" if={{editMode}}>
                                        <paper-icon-button style="color: red;" icon="close" idx="[[index]]" on-tap="removeFooter"></paper-icon-button>
                                    </template>
                                    <template is="dom-if" if={{!editColumns}}>
                                        <span>[[column.title]]</span>
                                    </template>
                                    <template is="dom-if" if={{editColumns}}>
                                        <paper-input label="Nom de la colonne" value="{{column.title}}"></paper-input>
                                    </template>
                                </div>
                                <template is="dom-if" if={{isAdmin}}>
                                    <template is="dom-if" if={{editMode}}>
                                        <div>
                                            <paper-icon-button icon="create" raised on-tap="editCol"
                                                hidden$="[[editColumns]]"></paper-icon-button>
                                            <paper-icon-button icon="close" raised on-tap="closeCol"
                                                hidden$="[[!editColumns]]"></paper-icon-button>
                                            <paper-menu-button class="add-link-button" horizontal-align="right" ignore-select
                                                opened="[[opened]]">
                                                <paper-icon-button icon="add" class="dropdown-trigger"></paper-icon-button>
                                                <!-- Pages -->
                                                <paper-submenu class="dropdown-content">
                                                    <paper-item class="menu-trigger">Pages</paper-item>
                                                    <paper-menu class="menu-content sublist" attr-for-selected="none">
                                                        <template is="dom-repeat" items={{pagesData}} 
                                                            as=item index-as=itemIdx>
                                                            <paper-item class="section-header-nw">[[item.title]]<paper-button raised class="save-button" path="page" item="[[item]]" column="[[column]]" on-tap="addToFooter">ajouter</paper-button></paper-item>
                                                        </template>
                                                    </paper-menu>
                                                </paper-submenu>

                                                <!-- Categories -->
                                                <paper-submenu class="dropdown-content">
                                                    <paper-item class="menu-trigger">Categories</paper-item>
                                                    <paper-menu class="menu-content sublist" attr-for-selected="none">
                                                        <template is="dom-repeat" items={{categoriesData}} 
                                                            as=item index-as=itemIdx>
                                                            <paper-item class="section-header-nw">[[item.name]] <paper-button raised class="save-button" item="[[item]]" column="[[column]]" path="categorie" on-tap="addToFooter">ajouter</paper-button></paper-item>
                                                        </template>
                                                    </paper-menu>
                                                </paper-submenu>

                                                <!-- Articles -->
                                                <paper-submenu class="dropdown-content">
                                                    <paper-item class="menu-trigger">Articles</paper-item>
                                                    <paper-menu class="menu-content sublist" attr-for-selected="none">
                                                        <template is="dom-repeat" items={{articlesData}} 
                                                            as=item index-as=itemIdx>
                                                            <paper-item class="section-header-nw">[[item.title]] <paper-button raised class="save-button" item="[[item]]" column="[[column]]" path$="lire/[[item.category]]" on-tap="addToFooter">ajouter</paper-button></paper-item>
                                                        </template>
                                                    </paper-menu>
                                                </paper-submenu>
                                            </paper-menu-button>
                                        </div>
                                    </template>
                                </template>
                            </div>
                            <polymer-dragula>
                                <ul>
                                    <template is="dom-repeat" items={{column.items}} 
                                    as=item>
                                        <li><a href="[[item.slug]]" title="[[item.title]]">[[item.title]]</a></li>
                                    </template>
                                </ul>
                            </polymer-dragula>
                        </div>
                    </template>
                </div>
            </polymer-dragula>
            <div class="end right">Ambition &amp; Réussite<iron-icon icon="copyright"></iron-icon>{{year}}</div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'ar-footer',

            properties: {
                rights: {
                    type: Object,
                },

                isAdmin: {
                    type: Boolean,
                    value: false,
                },

                editMode: {
                    type: Boolean,
                    value: false,
                },

                editColumns: {
                    type: Boolean,
                    value: false,
                },

                postionCounter: {
                    type: Number,
                    value: 0
                },

                fnMovesInner: {
                    type: Function,
                    value: function () {
                        return function (el, container, handle) {
                            return handle.classList.contains('edit');
                        }
                    }
                },

                columns: {
                    type: Array
                },
            },

            observers: [
                '_rightsChanged(rights.ts)',
            ],

            edit: function (e) {
                this.editMode = true;
                this.editClass = "edit";
            },

            close: function (e) {
                this.editMode = false;
                this.editClass = "";
            },

            editCol: function (e) {
                this.editColumns = true;
            },

            closeCol: function (e) {
                this.editColumns = false;
            },

            saveFooter: function (e) {
                var _this = this;
                var items = this.$$('.app-grid').querySelectorAll('.item');
                for (var i = 0; i < items.length; i++) {
                    this.set('footer.' + items[i].idx + '.position', i);
                    this.set('footer.' + items[i].idx + '.title', items[i].column.title);
                }
            },

            addColumn: function (e) {
                if (this.columnTitle) {
                    var _this = this;
                    this.$.footer.ref.push({
                        title: this.columnTitle,
                        position: this.footer.length ? this.footer.length : this.postionCounter++
                    });
                }

                this.columnTitle = null;
            },

            addToFooter: function (e) {
                var column = e.target.column;
                var item = e.target.item;
                var path = e.target.getAttribute('path');

                for (var i = 0; i < this.footer.length; i++) {
                    if (this.footer[i].$key == column.$key) {
                        if (!this.footer[i].items) {
                            this.set('footer.' + i + '.items', [{
                                title: item.title || item.name,
                                slug: '/' + path + '/' + item.slug,
                            }]);
                        } else {
                            this.push('footer.' + i + '.items', {
                                title: item.title,
                                slug: '/' + path + '/' + item.slug,
                            });
                        }
                    }
                }

                var menuBtn = Polymer.dom(this.root).querySelectorAll('.add-link-button');
                for (var i = menuBtn.length - 1; i >= 0; i--) {
                    menuBtn[i].close();
                }
            },

            removeFooter: function (e) {
                var idx = e.currentTarget.idx;
                this.splice('columns', idx, 1);
            },

            checkRights: function (role) {
                if (this.rights[role]) {
                    this.isAdmin = true;
                }
            },

            _sortFooter: function (a, b) {
                if (a.position < b.position) {
                    return -1;
                }
                if (a.position > b.position) {
                    return 1;
                }
                return 0;
            },

            _rightsChanged: function (ts) {
                this.checkRights('administrators');
            },

            _ucfirst: function (string) {
                if (string) {
                    return string.charAt(0).toUpperCase() + string.slice(1);
                }
                return '';
            }
        });
    </script>
</dom-module>