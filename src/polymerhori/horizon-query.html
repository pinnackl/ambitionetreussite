<link rel="import" href="/bower_components/polymer/polymer.html">
<link rel="import" href="horizon.html">

<dom-module id="horizon-query">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>
        
    </template>
    <script>
        Polymer({
            is: 'horizon-query',

            properties: {
                /**
                 * Horizon data query
                 * object computed by the following parameters.
                 */
                query: {
                    type: Object,
                    computed: '__computeQuery(orderByChild, limitToFirst, limitToLast, startAt, endAt, equalTo, path)'
                },

                /**
                 * The child key of each query result to order the query by.
                 *
                 * Changing this value generates a new `query` ordered by the
                 * specified child key.
                 */
                orderByChild: {
                    type: String,
                    value: ''
                },

                /**
                 * The value to start at in the query.
                 *
                 * Changing this value generates a new `query` with the specified
                 * starting point. The generated `query` includes children which match
                 * the specified starting point.
                 */
                startAt: {
                    type: String,
                    value: ''
                },

                /**
                 * The value to end at in the query.
                 *
                 * Changing this value generates a new `query` with the specified
                 * ending point. The generated `query` includes children which match
                 * the specified ending point.
                 */
                endAt: {
                    type: String,
                    value: ''
                },

                /**
                 * Specifies a child-key value that must be matched for each candidate result.
                 *
                 * Changing this value generates a new `query` which includes children
                 * which match the specified value.
                 */
                equalTo: {
                    type: Object,
                    value: null
                },

                /**
                 * The maximum number of nodes to include in the query.
                 *
                 * Changing this value generates a new `query` limited to the first
                 * number of children.
                 */
                limitToFirst: {
                    type: Number,
                    value: 0
                },

                /**
                 * The maximum number of nodes to include in the query.
                 *
                 * Changing this value generates a new `query` limited to the last
                 * number of children.
                 */
                limitToLast: {
                    type: Number,
                    value: 0
                },

                /**
                 * Path to a Horizon table. N.B. `path` is case sensitive.
                 */
                path: {
                    type: String,
                    value: null
                },

                /**
                 * Path to a Horizon table. N.B. `path` is case sensitive.
                 */
                data: {
                    type: Array,
                    notify: true,
                    value: function() {
                        return [];
                    }
                }
            },

            __computeQuery: function(orderByChild, limitToFirst, limitToLast, startAt, endAt, equalTo, path) {
                var horizon = window.horizon;

                if (path != null) {
                    var table = path.split('/').slice(1, 2).join('');
                    var collection = horizon(table);

                    if (orderByChild != null && equalTo != null) {
                        var keys = orderByChild.split("_");
                        var values = equalTo.split("~");
                        var aOrder = [];

                        for (var i = 0; i < keys.length; i++) {
                            var tmp = {};
                            tmp[keys[i]] = values[i];
                            aOrder.push(tmp);
                        }

                        // find a way to make it dynamic
                        collection.findAll(aOrder[0], aOrder[1], aOrder[2]).watch().subscribe(data => {
                            this.set('data', data);
                        });
                    } else {
                        collection.watch().subscribe(data => {
                            this.set('data', data);
                        });
                    }
                }
            }
        });
    </script>
</dom-module>
