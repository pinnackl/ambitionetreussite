<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<link rel="import" href="../../bower_components/iron-media-query/iron-media-query.html">

<link rel="import" href="../../bower_components/the-grid/the-grid.html">
<link rel="import" href="footer-tile.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="everest-footer">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            .section-header paper-icon-button {
                color: #444444
            }

            .footer-add-input {
                padding: 16px;
            }

            everest-sortable-grid {
                position: relative;
                bottom: 24px;
                margin-bottom: 8px;
            }

            .end {
                background-color: #f8f8f8;
            }

            .footer {
                min-height: 30vh;
            }

            .end.footer > .end.right {
                width: 100%;
                /*position: absolute;*/
                bottom: 0;
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 0 1 auto;
                -ms-flex: 0 1 auto;
                flex: 0 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }

            .right {
                text-align: center;
                vertical-align: middle;
                font-weight: bold;
                font-size: 12px;
                line-height: 24px;
                color: #757575;
            }

            .right iron-icon {
                height: 18px;
                vertical-align: middle;
            }

            [hidden] {
                display: none;
            }

            the-grid > div[placeholder] {
                background: #afafaf;
            }

            @media (max-width: 799px) {

            }
        </style>

        <iron-media-query query="min-width: 640px" query-matches="{{largeScreen}}">
        </iron-media-query>
        

        <!-- <firebase-query
            id="footer"
            path="/footer"
            data="{{footer}}">
        </firebase-query>
        <firebase-document
            path="/footer"
            data="{{footerDoc}}">
        </firebase-document>

        <firebase-query
            path="/pages"
            data="{{pagesData}}">
        </firebase-query>
        <firebase-query
            path="/categories"
            data="{{categoriesData}}">
        </firebase-query>
        <firebase-query
            path="/articles"
            data="{{articlesData}}">
        </firebase-query> -->
        <div class="end footer">
            <!-- <template is="dom-if" if={{isAdmin}}> -->
                <div class="footer-add-input section-header">
                    <div class="section-header">
                        <paper-input label="Add a column" hidden$="[[!editMode]]" value="{{columnTitle}}"></paper-input>
                        <paper-button class="save-button" raised hidden$="[[!editMode]]" on-tap="addColumn">Add</paper-button>
                    </div>
                    <template is="dom-if" if={{editMode}}>
                        <paper-button
                            class="save-button"
                            raised
                            on-tap="saveFooter">
                            <iron-icon icon="done"></iron-icon>Save</paper-button>
                    </template>
                    <paper-icon-button icon="create" raised on-tap="edit"
                        hidden$="[[editMode]]"></paper-icon-button>
                    <paper-icon-button icon="close" raised on-tap="close"
                        hidden$="[[!editMode]]"></paper-icon-button>
                </div>
            <!-- </template> -->
            <div>
                <the-grid
                    id="footerGrid"
                    draggable="[[editMode]]"
                    resizable="[[editMode]]"
                    animated
                    overlappable="[[editMode]]"
                    row-autogrow
                    col-count="{{nbCol}}"
                    row-count$="{{nbRow}}"
                    cell-width="{{cellWidth}}"
                    cell-height="{{cellHeight}}"
                    cell-margin="8">

                    <template is="dom-repeat" items=[[footers]] as=column index-as=index sort="_sortFooter" filter="{{_responsiveFooter(largeScreen)}}">
                        <footer-tile
                            edit$="[[editMode]]"
                            col$="{{_computeTileProperty('col',column,index)}}"
                            row$="{{_computeTileProperty('row',column,index)}}"
                            height$="{{column.height}}"
                            width$="{{_computeTileProperty('width',column,index)}}"
                            min-height="2"
                            column="{{column}}"
                            index="[[index]]"
                            on-move="_handleMove"
                            on-resize="_handleMove"
                            on-delete-tile="deleteColumn">
                            <span resize="top"></span>
                            <span resize="bottom"></span>
                        </footer-tile>
                    </template>
                    <div placeholder></div>
                </the-grid>
            </div>
            <div class="end right">EVEREST<iron-icon icon="copyright"></iron-icon>{{year}}</div>
        </div>
        <paper-toast id="stateMessage" horizontal-align="left" always-on-top duration="5000" text="" on-iron-overlay-closed="_toastClosed">
            <iron-icon id="toastIcon" class="validate-icon" icon$="[[stateMessageIcon]]"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'everest-footer',

            properties: {
                largeScreen: {
                    type: Boolean,
                },
                footers: {
                    type: Array,
                    value: function () {
                        return [];
                    }
                },

                rights: {
                    type: Object,
                },

                isAdmin: {
                    type: Boolean,
                    value: false,
                },

                editMode: {
                    type: Boolean,
                    value: false,
                },

                editColumns: {
                    type: Boolean,
                    value: false,
                },

                postionCounter: {
                    type: Number,
                    value: 0
                },

                itemPostionCounter: {
                    type: Number,
                    value: 0
                },

                columns: {
                    type: Array
                },

                itemOrder: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                },

                year: {
                    type: String,
                    value: function () {
                        var d = new Date();
                        return d.getFullYear();
                    }
                },


                nbCol: {
                    type: Number,
                    value: 12,
                    obsever: '_computeCellWidth'
                },

                nbRow: {
                    type: Number,
                    value: 6
                },

                cellHeight: {
                    type: Number,
                    value: 100,
                    notify: true
                },

                cellWidth: {
                    type: Number,
                    value: 100
                },

                cellMargin: {
                    type: Number,
                    value: 9
                },

                stateMessage: {
                    type: Object,
                    value: function () {
                        return {
                            'success': {
                                icon: "check-circle",
                                text: "Your changes have been saved!",
                            },
                            'errorExist': {
                                icon: "warning",
                                text: "Error! A footer with this title already exists!",
                            },
                            'errorEmpty': {
                                icon: "warning",
                                text: "Error! You must give a title to your footer!",
                            },
                            'errorCategory': {
                                icon: "warning",
                                text: "Error! You must assign a category to your article!",
                            },
                            'errorRight': {
                                icon: "warning",
                                text: "Error! You do not have the rights!",
                            },
                        }
                    }

                },
            },

            observers: [
                '_rightsChanged(rights.ts)',
                '_resizeFooter(footers, footers.splices, largeScreen)'
            ],

            ready: function () {
                // Init the compute of the grid
                this._computeCellWidth();

                window.addEventListener('resize', this._computeCellWidth.bind(this));

                this.push('footers',
                    {
                        title: "column 1",
                        col: 0,
                        row: 0,
                        height: 6,
                        width: 3,
                        items: [
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'page',
                                position: 0
                            },
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'article',
                                position: 1
                            },
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'category',
                                position: 2
                            },
                        ]
                    },
                    {
                        title: "column 2",
                        col: 3,
                        row: 0,
                        height: 6,
                        width: 3,
                        items: [
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'page',
                                position: 0
                            },
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'article',
                                position: 1
                            },
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'category',
                                position: 2
                            },
                        ]
                    },
                    {
                        title: "column 3",
                        col: 6,
                        row: 0,
                        height: 6,
                        width: 3,
                        items: [
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'page',
                                position: 0
                            },
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'article',
                                position: 1
                            },
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'category',
                                position: 2
                            },
                        ]
                    },
                    {
                        title: "column 4",
                        col: 9,
                        row: 0,
                        height: 6,
                        width: 3,
                        items: [
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'page',
                                position: 0
                            },
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'article',
                                position: 1
                            },
                            {
                                title: 'Some link',
                                link: '#',
                                type: 'category',
                                position: 2
                            },
                        ]
                    }
                );

                this.$.footerGrid.computeStyles(); 
            },

            edit: function (e) {
                this.editMode = true;
                this.editClass = "edit";
            },

            close: function (e) {
                this.editMode = false;
                this.editColumns = false;
                this.editClass = "";
            },

            editCol: function (e) {
                this.editColumns = true;
            },

            closeCol: function (e) {
                this.editColumns = false;
            },

            saveFooter: function (e) {
                var _this = this;

                const items = Polymer.dom(this.root).querySelectorAll('footer-tile');
                items.forEach((item, idx) => {
                    // Set new position
                    // item.column.position = idx;
                    console.log(item.column);
                });

                // for (var i = 0; i < items.length; i++) {
                //     var key = items[i].column.$key;
                //     for (j in items[i].column.items) {
                //         if (this.itemOrder[key] && typeof this.itemOrder[key][j] != 'undefined') {
                //             this.$.footer.ref.child(key).child('items').child(j).update({
                //                 position: this.itemOrder[key][j]
                //             });
                //         }
                //     }

                //     this.$.footer.ref.child(key).update({
                //         title: items[i].column.title,
                //         position: i,
                //     }).catch(function (error) {
                //         _this.stateMessageIcon = _this.stateMessage.errorRight.icon;
                //         _this.$.stateMessage.text = _this.stateMessage.errorRight.text;
                //         _this.$.stateMessage.open();
                //     });
                // }

                // this.stateMessageIcon = _this.stateMessage.success.icon;
                // this.$.stateMessage.text = _this.stateMessage.success.text;
                // this.$.stateMessage.open();
            },

            reorderItem: function (e, detail) {
                this.itemOrder[detail.column] = detail.order;
            },

            addColumn: function (e) {
                // Max col number = 4
                if (this.columnTitle && this.footers.length < 4) {
                    let len = this.footers.length;
                    
                    // compute the tile width
                    // Add +1 to update len before push into array
                    let width = this.nbCol/(len+1);

                    // Loop to set new metrics
                    var pos;
                    this.footers.forEach((item, idx) => {
                        this.set(['footers', idx, 'width'], width);
                        if (item.col > 0) {
                            this.set(['footers', idx, 'col'], pos*idx);
                        }
                        pos = parseInt(width);
                    });

                    this.push('footers', {
                        title: this.columnTitle,
                        col: len*width,
                        row: 0,
                        width: width,
                        height: 6,
                        items: []
                    });
                }

                this.columnTitle = null;
            },


            deleteColumn: function (e) {
                if(this.largeScreen) {
                    if (this.footers.length) {
                        this.arrayDelete('footers', e.detail.column);

                        let len = this.footers.length;

                        // compute the tile width
                        let width = this.nbCol/len;

                        // Loop to set new metrics
                        var pos = 0;
                        this.footers.forEach((item, idx) => {
                            if (idx == 0)
                                this.set(['footers', idx, 'col'], 0);
                            else
                                this.set(['footers', idx, 'col'], pos*idx);

                            pos = parseInt(width);

                            this.set(['footers', idx, 'width'], width);
                        });

                    }
                } else {
                    if (this.footers.length) {
                        console.log(e.detail);
                        this.arrayDelete('footers', e.detail.column);
                        // Loop to set new metrics
                        var pos = 0;
                        var rows = 0;
                        this.footers.forEach((item, idx) => {
                            if (idx == 0)
                                this.set(['footers', idx, 'row'], 0);
                            else
                                this.set(['footers', idx, 'row'], pos*idx);

                            pos = parseInt(item.height);
                            rows += parseInt(item.height);
                        });
                        this.$.footerGrid.rowCount = rows;
                    }
                }
            },

            addToFooter: function (e) {
                var column = e.target.column;
                var key = column.$key;
                var item = e.target.item;
                var path = e.target.getAttribute('path');
                this.$.footer.ref.child(key).child('items').push({
                    title: item.title || item.name,
                    slug: '/' + path + '/' + item.slug,
                    position: column.items ? Object.keys(column.items).length : this.itemPostionCounter++
                });

                var menuBtn = Polymer.dom(this.root).querySelectorAll('.add-link-button');
                for (var i = menuBtn.length - 1; i >= 0; i--) {
                    menuBtn[i].close();
                }
            },

            _computeCellWidth: function () {
                this.cellHeight = ((window.innerHeight * 30) / 100 - this.cellMargin * ( this.nbRow - 1)) / this.nbRow;
                this.cellWidth = (window.innerWidth - (2*8) - this.cellMargin * ( this.nbCol - 1)) / this.nbCol;
            },

            /**
             * Handle any tile move and save it new props
             *
             * @param      {Event}  event   the move event object
             */
            _handleMove: function (event) {
                let idx = event.detail.tile.index;
                if (this.footers[idx]) {
                    if (event.detail.tile.col)
                        this.footers[idx].col = event.detail.tile.col;

                    if (event.detail.tile.row)
                        this.footers[idx].row = event.detail.tile.row;

                    if (event.detail.tile.height)
                        this.footers[idx].height = event.detail.tile.height;

                    if (event.detail.tile.width)
                        this.footers[idx].width = event.detail.tile.width;
                }
            },

            checkRights: function (role) {
                if (this.rights[role]) {
                    this.isAdmin = true;
                } else {
                    this.isAdmin = false;
                }
            },

            _toastClosed: function (e) {
                this.close();
                this.columnTitle = null;
            },

            _sortFooter: function (a, b) {
                if (a.position < b.position) {
                    return -1;
                }
                if (a.position > b.position) {
                    return 1;
                }
                return 0;
            },

            _rightsChanged: function (ts) {
                this.checkRights('administrators');
            },

            _ucfirst: function (string) {
                if (string) {
                    return string.charAt(0).toUpperCase() + string.slice(1);
                }
                return '';
            },

            _resizeFooter: function (obj, changeRecord, ls) {
                // if (this.footers.length) {
                //     if(!ls) {           
                //         var rows=0;
                //         this.footers.forEach((item) => {
                //             rows += parseInt(item.height);
                //         });
                //         this.$.footerGrid.rowCount = rows;
                //         this.$.footerGrid.computeStyles();
                        
                //     } else {
                //         var rows = 0;
                //         this.footers.forEach((item) => {                           
                //             if(rows<item.height)
                //                 rows = parseInt(item.height);
                //         });
                //         this.$.footerGrid.rowCount = rows;
                //         this.$.footerGrid.computeStyles();
                //     }
                // }
            },

            _computeTileProperty: function (property, item, idx) {
                if (!this.largeScreen) {
                    this.$.footerGrid.computeStyles();
                    var rows=0;
                    this.footers.forEach((item) => {
                        rows += parseInt(item.height);
                    });
                    this.$.footerGrid.rowCount = rows;
                    switch(property) {
                        case 'width':
                            return this.nbCol;
                        case 'row':
                            if (item.col >0)
                                return parseInt(item.height)*idx;
                            return 0;
                        case 'col':
                            return 0;     
                    }
                } 
                else {
                    var rows=0;
                    this.footers.forEach((item) => {
                        rows = parseInt(item.height);
                    });
                    this.$.footerGrid.rowCount = rows;
                    switch(property) {
                        case 'width':
                            return item.width;
                        case 'row':
                            return item.row;
                        case 'col':
                            return item.col;     
                    }
                }
            },

            _responsiveFooter: function (ls) {
                // if(!ls){
                        
                //     // Cumpute the tile width
                //     let width = this.nbCol;

                //     // Loop to set new metrics
                //     var pos;
                //     var rows=0;
                //     this.footers.forEach((item, idx) => {
                //         this.set(['footers', idx, 'width'], width);
                //         if (item.col > 0) {
                //             this.set(['footers', idx, 'row'], pos*idx);
                //             this.set(['footers', idx, 'col'], 0);
                //         }
                //         pos = parseInt(item.height);
                //         rows += parseInt(item.height);
                //     });
                //     this.$.footerGrid.rowCount = rows;

                // } else {
                //     let len = this.footers.length;

                //     // Cumpute the tile width
                //     let width = this.nbCol/len;

                //     // Loop to set new metrics
                //     var pos = 0;
                //     var rows = 0;
                //     this.footers.forEach((item, idx) => {
                //         this.set(['footers', idx, 'row'], 0);
                //         if (idx == 0)
                //             this.set(['footers', idx, 'col'], 0);
                //         else
                //             this.set(['footers', idx, 'col'], pos*idx);

                //         pos = parseInt(width);

                //         this.set(['footers', idx, 'width'], width);
                        
                //         if(rows<item.height)
                //             rows = parseInt(item.height);
                //     });
                //     this.$.footerGrid.rowCount = rows;
                // }
            }
        });
    </script>
</dom-module>
