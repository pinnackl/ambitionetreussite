<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-menu-button/paper-menu-button.html">
<!-- <link rel="import" href="../../bower_components/paper-menu/paper-submenu.html"> -->

<link rel="import" href="../everest-sortable-grid/everest-sortable-grid.html">
<link rel="import" href="footer-tile.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="everest-footer">
    <template>
        <style include="shared-styles">
            :host {
                display: block;
            }

            .section-header paper-icon-button {
                color: #444444
            }

            .footer-add-input {
                padding: 16px;
            }

            everest-sortable-grid {
                position: relative;
                bottom: 24px;
                margin-bottom: 8px;
            }

            .end {
                background-color: #f8f8f8;
            }

            .footer {
                min-height: 30vh;
            }

            .end.footer > .end.right {
                width: 100%;
                position: absolute;
                bottom: 0;
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 0 1 auto;
                -ms-flex: 0 1 auto;
                flex: 0 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }

            .right {
                text-align: center;
                vertical-align: middle;
                font-weight: bold;
                font-size: 12px;
                line-height: 24px;
                color: #757575;
            }

            .right iron-icon {
                height: 18px;
                vertical-align: middle;
            }

            [hidden] {
                display: none;
            }

            @media (max-width: 799px) {

            }
        </style>

        <!-- <firebase-query
            id="footer"
            path="/footer"
            data="{{footer}}">
        </firebase-query>
        <firebase-document
            path="/footer"
            data="{{footerDoc}}">
        </firebase-document>

        <firebase-query
            path="/pages"
            data="{{pagesData}}">
        </firebase-query>
        <firebase-query
            path="/categories"
            data="{{categoriesData}}">
        </firebase-query>
        <firebase-query
            path="/articles"
            data="{{articlesData}}">
        </firebase-query> -->
        <div class="end footer">
            <!-- <template is="dom-if" if={{isAdmin}}> -->
                <div class="footer-add-input section-header">
                    <div class="section-header">
                        <paper-input label="Add a column" hidden$="[[!editMode]]" value="{{columnTitle}}"></paper-input>
                        <paper-button class="save-button" raised hidden$="[[!editMode]]" on-tap="addColumn">Add</paper-button>
                    </div>
                    <template is="dom-if" if={{editMode}}>
                        <paper-button
                            class="save-button"
                            raised
                            on-tap="saveFooter">
                            <iron-icon icon="done"></iron-icon>Save</paper-button>
                    </template>
                    <paper-icon-button icon="create" raised on-tap="edit"
                        hidden$="[[editMode]]"></paper-icon-button>
                    <paper-icon-button icon="close" raised on-tap="close"
                        hidden$="[[!editMode]]"></paper-icon-button>
                </div>
            <!-- </template> -->

            <everest-sortable-grid disabled="[[!editMode]]">
                <template is="dom-repeat" items=[[footers]] as=column index-as=index sort="_sortFooter">

                    <footer-tile edit$="[[editMode]]" column="{{column}}" position="{{column.position}}"></footer-tile>

                </template>
            </everest-sortable-grid>
            <div class="end right">EVEREST<iron-icon icon="copyright"></iron-icon>{{year}}</div>
        </div>
        <paper-toast id="stateMessage" horizontal-align="left" always-on-top duration="5000" text="" on-iron-overlay-closed="_toastClosed">
            <iron-icon id="toastIcon" class="validate-icon" icon$="[[stateMessageIcon]]"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'everest-footer',

            properties: {
                footers: {
                    type: Array,
                    value: function () {
                        return [
                            {
                                title: "column 1",
                                position: 0,
                                items: []
                            },
                            {
                                title: "column 2",
                                position: 2,
                                items: []
                            },
                            {
                                title: "column 3",
                                position: 1,
                                items: []
                            },
                            {
                                title: "column 4",
                                position: 3,
                                items: []
                            },
                        ];
                    }
                },

                rights: {
                    type: Object,
                },

                isAdmin: {
                    type: Boolean,
                    value: false,
                },

                editMode: {
                    type: Boolean,
                    value: false,
                },

                editColumns: {
                    type: Boolean,
                    value: false,
                },

                postionCounter: {
                    type: Number,
                    value: 0
                },

                itemPostionCounter: {
                    type: Number,
                    value: 0
                },

                columns: {
                    type: Array
                },

                itemOrder: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                },

                year: {
                    type: String,
                    value: function () {
                        var d = new Date();
                        return d.getFullYear();
                    }
                },

                stateMessage: {
                    type: Object,
                    value: function () {
                        return {
                            'success': {
                                icon: "check-circle",
                                text: "Your changes have been saved!",
                            },
                            'errorExist': {
                                icon: "warning",
                                text: "Error! A footer with this title already exists!",
                            },
                            'errorEmpty': {
                                icon: "warning",
                                text: "Error! You must give a title to your footer!",
                            },
                            'errorCategory': {
                                icon: "warning",
                                text: "Error! You must assign a category to your article!",
                            },
                            'errorRight': {
                                icon: "warning",
                                text: "Error! You do not have the rights!",
                            },
                        }
                    }
                },
            },

            observers: [
                '_rightsChanged(rights.ts)',
            ],

            ready: function () {
                // Init the cumpute of the grid
                this._computeCellWidth();

                window.addEventListener('resize', this._computeCellWidth.bind(this));
            },

            _computeCellWidth: function () {
                this.cellMargin = 10;
                this.nbCol = 12;
                this.nbRow = 6;

                this.cellHeight = ((window.innerHeight * 30) / 100 - this.cellMargin * ( this.nbRow - 1)) / this.nbRow;
                this.cellWidth = (window.innerWidth - (2*8) - this.cellMargin * ( this.nbCol - 1)) / this.nbCol;
            },

            edit: function (e) {
                this.editMode = true;
                this.editClass = "edit";
            },

            close: function (e) {
                this.editMode = false;
                this.editColumns = false;
                this.editClass = "";
            },

            editCol: function (e) {
                this.editColumns = true;
            },

            closeCol: function (e) {
                this.editColumns = false;
            },

            saveFooter: function (e) {
                var _this = this;

                const items = Polymer.dom(this.root).querySelectorAll('footer-tile');
                items.forEach((item, idx) => {
                    // Set new position
                    item.column.position = idx;
                    console.log(item.column);
                });

                // for (var i = 0; i < items.length; i++) {
                //     var key = items[i].column.$key;
                //     for (j in items[i].column.items) {
                //         if (this.itemOrder[key] && typeof this.itemOrder[key][j] != 'undefined') {
                //             this.$.footer.ref.child(key).child('items').child(j).update({
                //                 position: this.itemOrder[key][j]
                //             });
                //         }
                //     }

                //     this.$.footer.ref.child(key).update({
                //         title: items[i].column.title,
                //         position: i,
                //     }).catch(function (error) {
                //         _this.stateMessageIcon = _this.stateMessage.errorRight.icon;
                //         _this.$.stateMessage.text = _this.stateMessage.errorRight.text;
                //         _this.$.stateMessage.open();
                //     });
                // }

                // this.stateMessageIcon = _this.stateMessage.success.icon;
                // this.$.stateMessage.text = _this.stateMessage.success.text;
                // this.$.stateMessage.open();
            },

            reorderItem: function (e, detail) {
                this.itemOrder[detail.column] = detail.order;
            },

            addColumn: function (e) {
                if (this.columnTitle) {
                    this.push('footers', {
                        title: this.columnTitle,
                        postion: this.footers.length,
                        items: []
                    });

                    // this.$.footer.ref.push({
                    //     title: this.columnTitle,
                    //     position: this.footer.length ? this.footer.length : this.postionCounter++
                    // });
                }

                this.columnTitle = null;
            },

            addToFooter: function (e) {
                var column = e.target.column;
                var key = column.$key;
                var item = e.target.item;
                var path = e.target.getAttribute('path');
                this.$.footer.ref.child(key).child('items').push({
                    title: item.title || item.name,
                    slug: '/' + path + '/' + item.slug,
                    position: column.items ? Object.keys(column.items).length : this.itemPostionCounter++
                });

                var menuBtn = Polymer.dom(this.root).querySelectorAll('.add-link-button');
                for (var i = menuBtn.length - 1; i >= 0; i--) {
                    menuBtn[i].close();
                }
            },

            removeFooter: function (e) {
                var column = e.currentTarget.column;
                var key = column.$key;
                this.$.footer.ref.child(key).remove();
            },

            checkRights: function (role) {
                if (this.rights[role]) {
                    this.isAdmin = true;
                } else {
                    this.isAdmin = false;
                }
            },

            _toastClosed: function (e) {
                this.close();
                this.columnTitle = null;
            },

            _sortFooter: function (a, b) {
                if (a.position < b.position) {
                    return -1;
                }
                if (a.position > b.position) {
                    return 1;
                }
                return 0;
            },

            _rightsChanged: function (ts) {
                this.checkRights('administrators');
            },

            _ucfirst: function (string) {
                if (string) {
                    return string.charAt(0).toUpperCase() + string.slice(1);
                }
                return '';
            }
        });
    </script>
</dom-module>
