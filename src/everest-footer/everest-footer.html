<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer-dragula/polymer-dragula.html">
<link rel="import" href="../../bower_components/polymer-dragula/polymer-dragula-styles.html">
<link rel="import" href="../../bower_components/paper-menu/paper-submenu.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">

<link rel="import" href="everest-footer-item.html">
<link rel="import" href="../shared-styles.html">
<dom-module id="everest-footer">
    <template>
        <style include="shared-styles polymer-dragula-styles">
            :host {
                display: block;
            }

            .section-header-nw {
                display: flex;
                flex-wrap: nowrap;
                justify-content: space-between;
                margin-bottom: 1em;
                align-items: center;
            }

            .app-grid {
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: row;
                -ms-flex-direction: row;
                flex-direction: row;
                -webkit-flex-wrap: nowrap;
                -ms-flex-wrap: nowrap;
                flex-wrap: nowrap;
                -webkit-justify-content: space-around;
                -ms-flex-pack: distribute;
                justify-content: space-around;
                -webkit-align-content: stretch;
                -ms-flex-line-pack: stretch;
                align-content: stretch;
                -webkit-align-items: stretch;
                -ms-flex-align: stretch;
                align-items: stretch;
                padding-top: 0px;
                padding-left: 0px;
                box-sizing: border-box;
            }

            .end {
                background-color: #f8f8f8;
            }

            .footer {
                min-height: 30vh;
            }

            .end.footer {
                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: column;
                -ms-flex-direction: column;
                flex-direction: column;
                -webkit-flex-wrap: nowrap;
                -ms-flex-wrap: nowrap;
                flex-wrap: nowrap;
                -webkit-justify-content: center;
                -ms-flex-pack: center;
                justify-content: center;
                -webkit-align-content: stretch;
                -ms-flex-line-pack: stretch;
                align-content: stretch;
                -webkit-align-items: stretch;
                -ms-flex-align: stretch;
                align-items: stretch;
            }

            .end.footer > polymer-dragula {
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 1 1 auto;
                -ms-flex: 1 1 auto;
                flex: 1 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }

            .end.footer > .end.right {
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 0 1 auto;
                -ms-flex: 0 1 auto;
                flex: 0 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }

            .item {
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 1 1 auto;
                -ms-flex: 1 1 auto;
                flex: 1 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto
            }

            .item.iedit {
                padding: 3px;
                min-height: 30vh;
                background-color: #F1F1F1;
                border: dotted 3px #fbc009;
                margin: 0 3px;
                cursor: pointer;

                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                user-select: none !important;

                display: -ms-flexbox;
                display: -webkit-flex;
                display: flex;
                -webkit-flex-direction: row;
                -ms-flex-direction: row;
                flex-direction: row;
                -webkit-flex-wrap: nowrap;
                -ms-flex-wrap: nowrap;
                flex-wrap: nowrap;
                -webkit-justify-content: flex-start;
                -ms-flex-pack: start;
                justify-content: flex-start;
                -webkit-align-content: stretch;
                -ms-flex-line-pack: stretch;
                align-content: stretch;
                -webkit-align-items: stretch;
                -ms-flex-align: stretch;
                align-items: stretch;
            }

            .item .handle {
                display: none;
            }

            .item.iedit .handle {
                color: #ffffff;
                background-color: #179bd7;
                display: flex;
                justify-content: center;
                align-items: center;

                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 0 1 auto;
                -ms-flex: 0 1 auto;
                flex: 0 1 auto;
                -webkit-align-self: center;
                -ms-flex-item-align: center;
                align-self: auto;
            }

            .item.iedit .content {
                -webkit-order: 0;
                -ms-flex-order: 0;
                order: 0;
                -webkit-flex: 1 1 auto;
                -ms-flex: 1 1 auto;
                flex: 1 1 auto;
                -webkit-align-self: auto;
                -ms-flex-item-align: auto;
                align-self: auto;
            }

            .right {
                text-align: center;
                vertical-align: middle;
                font-weight: bold;
                font-size: 12px;
                line-height: 24px;
                color: #757575;
            }

            .right iron-icon {
                height: 18px;
                vertical-align: middle;
            }

            .item .footer-cln-header {
                padding-left: 35px;
                font-weight: bold;
                font-size: 12px;
                line-height: 24px;
                color: #179BD7;
            }

            ul, li {
                list-style: none;
            }

            li a {
                color: #757575;
                font-size: 12px;
                text-decoration: none;
                line-height: 24px;
            }

            li.iedit {
                border: dotted 3px #179BD7;
                margin-bottom: 8px;
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                user-select: none !important;
            }

            .edit, .inneredit {
                cursor: move;
                cursor: grab;
                cursor: -moz-grab;
                cursor: -webkit-grab;
            }

            .gu-mirror {
                position: fixed !important;
                margin: 0 !important;
                z-index: 9999 !important;
                opacity: 0.8;
                -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=80)";
                filter: alpha(opacity=80);
                cursor: grabbing;
                cursor: -moz-grabbing;
                cursor: -webkit-grabbing;
            }

            .gu-hide {
                display: none !important;
            }

            .gu-unselectable {
                -webkit-user-select: none !important;
                -moz-user-select: none !important;
                -ms-user-select: none !important;
                user-select: none !important;
            }

            .gu-transit {
                background-color: rgba(23, 155, 215, 0.23)!important;
                border: dotted 3px #757575!important;
                opacity: 0.2;
                -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=20)";
                filter: alpha(opacity=20);
            }

            .footer-add-input {
                padding: 16px;
            }

            .add-link-button {
                --paper-menu-button-dropdown: {
                    width: 400px;
                    margin-bottom: 30px;
                }
            }

            .section-header paper-icon-button {
                color: #444444
            }

            .sublist paper-item {
              padding-left: 30px;
            }

            @media (max-width: 799px) {
                .app-grid {
                    -webkit-flex-direction: column;
                    -ms-flex-direction: column;
                    flex-direction: column;
                }
            }
        </style>

        <firebase-query
            id="footer"
            path="/footer"
            data="{{footer}}">
        </firebase-query>
        <firebase-document
            path="/footer"
            data="{{footerDoc}}">
        </firebase-document>

        <firebase-query
            path="/pages"
            data="{{pagesData}}">
        </firebase-query>
        <firebase-query
            path="/categories"
            data="{{categoriesData}}">
        </firebase-query>
        <firebase-query
            path="/articles"
            data="{{articlesData}}">
        </firebase-query>
        <div class="end footer">
            <template is="dom-if" if={{isAdmin}}>
                <div class="footer-add-input section-header">
                    <div class="section-header">
                        <paper-input label="Add a column" hidden$="[[!editMode]]" value="{{columnTitle}}"></paper-input>
                        <paper-button class="save-button" raised hidden$="[[!editMode]]" on-tap="addColumn">Add</paper-button>
                    </div>
                    <template is="dom-if" if={{editMode}}>
                        <paper-button
                            class="save-button"
                            raised
                            on-tap="saveFooter">
                            <iron-icon icon="done"></iron-icon>Save</paper-button>
                    </template>
                    <paper-icon-button icon="create" raised on-tap="edit"
                        hidden$="[[editMode]]"></paper-icon-button>
                    <paper-icon-button icon="close" raised on-tap="close"
                        hidden$="[[!editMode]]"></paper-icon-button>
                </div>
            </template>
            <polymer-dragula direction="horizontal" fn-moves="[[fnMoves]]" copy-sort-source>
                <div class="app-grid">
                    <template is="dom-repeat" items=[[footer]]
                        as=column index-as=index sort="_sortFooter">
                        <div class$="item i[[editClass]]" column="[[column]]" idx="[[index]]">
                            <div class$="handle [[editClass]]"><iron-icon icon="more-vert"></iron-icon></div>
                            <div class="content">
                                <div class="footer-cln-header section-header">
                                    <div>
                                        <template is="dom-if" if={{editMode}}>
                                            <paper-icon-button style="color: red;" icon="close" column="[[column]]" on-tap="removeFooter"></paper-icon-button>
                                        </template>
                                        <template is="dom-if" if={{!editColumns}}>
                                            <span>[[column.title]]</span>
                                        </template>
                                        <template is="dom-if" if={{editColumns}}>
                                            <paper-input label="Name of the column" value="{{column.title}}"></paper-input>
                                        </template>
                                    </div>
                                    <template is="dom-if" if={{isAdmin}}>
                                        <template is="dom-if" if={{editMode}}>
                                            <div>
                                                <paper-icon-button icon="create" raised on-tap="editCol"
                                                    hidden$="[[editColumns]]"></paper-icon-button>
                                                <paper-icon-button icon="close" raised on-tap="closeCol"
                                                    hidden$="[[!editColumns]]"></paper-icon-button>
                                                <paper-menu-button class="add-link-button" horizontal-align="right" ignore-select
                                                    opened="[[opened]]">
                                                    <paper-icon-button icon="add" class="dropdown-trigger"></paper-icon-button>
                                                    <!-- Pages -->
                                                    <paper-submenu class="dropdown-content">
                                                        <paper-item class="menu-trigger">Pages</paper-item>
                                                        <paper-menu class="menu-content sublist" attr-for-selected="none">
                                                            <template is="dom-repeat" items={{pagesData}}
                                                                as=item index-as=itemIdx>
                                                                <paper-item class="section-header-nw">[[item.title]]<paper-button raised class="save-button" path="page" item="[[item]]" column="[[column]]" on-tap="addToFooter">Add</paper-button></paper-item>
                                                            </template>
                                                        </paper-menu>
                                                    </paper-submenu>

                                                    <!-- Categories -->
                                                    <paper-submenu class="dropdown-content">
                                                        <paper-item class="menu-trigger">Categories</paper-item>
                                                        <paper-menu class="menu-content sublist" attr-for-selected="none">
                                                            <template is="dom-repeat" items={{categoriesData}}
                                                                as=item index-as=itemIdx>
                                                                <paper-item class="section-header-nw">[[item.name]] <paper-button raised class="save-button" item="[[item]]" column="[[column]]" path="categorie" on-tap="addToFooter">Add</paper-button></paper-item>
                                                            </template>
                                                        </paper-menu>
                                                    </paper-submenu>

                                                    <!-- Articles -->
                                                    <paper-submenu class="dropdown-content">
                                                        <paper-item class="menu-trigger">Articles</paper-item>
                                                        <paper-menu class="menu-content sublist" attr-for-selected="none">
                                                            <template is="dom-repeat" items={{articlesData}}
                                                                as=item index-as=itemIdx>
                                                                <paper-item class="section-header-nw">[[item.title]] <paper-button raised class="save-button" item="[[item]]" column="[[column]]" path$="lire/[[item.category]]" on-tap="addToFooter">Add</paper-button></paper-item>
                                                            </template>
                                                        </paper-menu>
                                                    </paper-submenu>
                                                </paper-menu-button>
                                            </div>
                                        </template>
                                    </template>
                                </div>
                                <everest-footer-item
                                    edit-mode="[[editMode]]"
                                    edit-class="[[editClass]]"
                                    column="[[column]]"
                                    on-reorder="reorderItem"
                                ></everest-footer-item>
                            </div>
                        </div>
                    </template>
                </div>
            </polymer-dragula>
            <div class="end right">EVEREST<iron-icon icon="copyright"></iron-icon>{{year}}</div>
        </div>
        <paper-toast id="stateMessage" horizontal-align="left" always-on-top duration="5000" text="" on-iron-overlay-closed="_toastClosed">
            <iron-icon id="toastIcon" class="validate-icon" icon$="[[stateMessageIcon]]"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'everest-footer',

            properties: {
                rights: {
                    type: Object,
                },

                isAdmin: {
                    type: Boolean,
                    value: false,
                },

                editMode: {
                    type: Boolean,
                    value: false,
                },

                editColumns: {
                    type: Boolean,
                    value: false,
                },

                postionCounter: {
                    type: Number,
                    value: 0
                },

                itemPostionCounter: {
                    type: Number,
                    value: 0
                },

                fnMoves: {
                    type: Function,
                    value: function () {
                        return function (el, container, handle) {
                            return handle.classList.contains('edit') || handle.parentNode.classList.contains('edit');
                        }
                    }
                },

                fnMovesInner: {
                    type: Function,
                    value: function () {
                        return function (el, container, handle) {
                            return handle.classList.contains('inneredit');
                        }
                    }
                },

                columns: {
                    type: Array
                },

                itemOrder: {
                    type: Object,
                    value: function () {
                        return {};
                    },
                },

                year: {
                    type: String,
                    value: function () {
                        var d = new Date();
                        return d.getFullYear();
                    }
                },

                stateMessage: {
                    type: Object,
                    value: function () {
                        return {
                            'success': {
                                icon: "check-circle",
                                text: "Your changes have been saved!",
                            },
                            'errorExist': {
                                icon: "warning",
                                text: "Error! A footer with this title already exists!",
                            },
                            'errorEmpty': {
                                icon: "warning",
                                text: "Error! You must give a title to your footer!",
                            },
                            'errorCategory': {
                                icon: "warning",
                                text: "Error! You must assign a category to your article!",
                            },
                            'errorRight': {
                                icon: "warning",
                                text: "Error! You do not have the rights!",
                            },
                        }
                    }
                },
            },

            observers: [
                '_rightsChanged(rights.ts)',
            ],

            edit: function (e) {
                this.editMode = true;
                this.editClass = "edit";
            },

            close: function (e) {
                this.editMode = false;
                this.editColumns = false;
                this.editClass = "";
            },

            editCol: function (e) {
                this.editColumns = true;
            },

            closeCol: function (e) {
                this.editColumns = false;
            },

            saveFooter: function (e) {
                var _this = this;
                var items = this.$$('.app-grid').querySelectorAll('.item');
                for (var i = 0; i < items.length; i++) {
                    var key = items[i].column.$key;
                    for (j in items[i].column.items) {
                        if (this.itemOrder[key] && typeof this.itemOrder[key][j] != 'undefined') {
                            this.$.footer.ref.child(key).child('items').child(j).update({
                                position: this.itemOrder[key][j]
                            });
                        }
                    }

                    this.$.footer.ref.child(key).update({
                        title: items[i].column.title,
                        position: i,
                    }).catch(function (error) {
                        _this.stateMessageIcon = _this.stateMessage.errorRight.icon;
                        _this.$.stateMessage.text = _this.stateMessage.errorRight.text;
                        _this.$.stateMessage.open();
                    });
                }

                this.stateMessageIcon = _this.stateMessage.success.icon;
                this.$.stateMessage.text = _this.stateMessage.success.text;
                this.$.stateMessage.open();
            },

            reorderItem: function (e, detail) {
                this.itemOrder[detail.column] = detail.order;
            },

            addColumn: function (e) {
                if (this.columnTitle) {
                    var _this = this;
                    this.$.footer.ref.push({
                        title: this.columnTitle,
                        position: this.footer.length ? this.footer.length : this.postionCounter++
                    });
                }

                this.columnTitle = null;
            },

            addToFooter: function (e) {
                var column = e.target.column;
                var key = column.$key;
                var item = e.target.item;
                var path = e.target.getAttribute('path');
                this.$.footer.ref.child(key).child('items').push({
                    title: item.title || item.name,
                    slug: '/' + path + '/' + item.slug,
                    position: column.items ? Object.keys(column.items).length : this.itemPostionCounter++
                });

                var menuBtn = Polymer.dom(this.root).querySelectorAll('.add-link-button');
                for (var i = menuBtn.length - 1; i >= 0; i--) {
                    menuBtn[i].close();
                }
            },

            removeFooter: function (e) {
                var column = e.currentTarget.column;
                var key = column.$key;
                this.$.footer.ref.child(key).remove();
            },

            checkRights: function (role) {
                if (this.rights[role]) {
                    this.isAdmin = true;
                } else {
                    this.isAdmin = false;
                }
            },

            _toastClosed: function (e) {
                this.close();
                this.columnTitle = null;
            },

            _sortFooter: function (a, b) {
                if (a.position < b.position) {
                    return -1;
                }
                if (a.position > b.position) {
                    return 1;
                }
                return 0;
            },

            _rightsChanged: function (ts) {
                this.checkRights('administrators');
            },

            _ucfirst: function (string) {
                if (string) {
                    return string.charAt(0).toUpperCase() + string.slice(1);
                }
                return '';
            }
        });
    </script>
</dom-module>
