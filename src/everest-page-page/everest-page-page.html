<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/polymer-mce/polymer-mce.html" async>
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../everest-page-create/page-tile.html">

<link rel="import" href="../shared-styles.html">
<dom-module id="everest-page-page">
    <template>
        <style include="shared-styles app-grid-style">
             :host {
                display: block;
                min-height: 100vh;
                width: 100%;
                --grid-width: 100%;
                --app-grid-columns: 3;
                --app-grid-item-height: 200px;
            }
            
            [name=spinner] {
                min-height: 50vh;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            
            .material {
                background: #ffffff;
                height: 100%;
                color: #444444;
            }
            
            .material h1 {
                padding-left: 8px;
                border-left: solid #3eb7e9 6px;
                color: #56585c;
            }
            
            .material .section-header {
                margin: 0 8px;
            }
            
            .material .section-header a {
                text-decoration: none;
                color: #757575;
                display: block;
            }
            
            #collapse {
                color: #757575;
                text-align: center;
            }
            
            .page-list {
                margin-bottom: 8px;
            }
            
            .page-list {
                padding: 16px;
                -webkit-box-shadow: 0 2px 5px 0 #cccccc;
                box-shadow: 0 2px 5px 0 #cccccc;
            }
            
            a.page-card {
                text-align: center;
                text-decoration: none;
            }
            
            .page-card .material {
                height: auto;
            }

            the-grid {
                margin: 16px 0;
                background: #f7f7f7;
                width: 100%;
                height: 100%;
            }

            the-grid > div[placeholder] {
                background: #afafaf;
            }

            paper-item {
                min-height: 48px;
                padding: 0px;
            }

            paper-item paper-button {
                width: 100%;
                background: #179bd7;
                color: #ffffff;
            }

            @media (max-width: 799px) {
                 :host {
                    --app-grid-columns: 1;
                }
            }
        </style>

        <horizon-document id="page" path="/pages/[[uid]]">
        </horizon-document>

        <horizon-query path="/pages" order-by-child="published_trash" equal-to="[[combinedFilters]]" data="{{pages}}"></horizon-query>

        <div class="material">
            <div class="section-header">
                <h1>[[_ucfirst(page.title)]]</h1>
                <template is="dom-if" if={{isAdmin}}>
                    <paper-icon-button icon="create" raised on-tap="edit" hidden$="[[editMode]]"></paper-icon-button>
                    <paper-icon-button icon="close" raised on-tap="close" hidden$="[[!editMode]]"></paper-icon-button>
                </template>
            </div>
            <template is="dom-if" if={{isAdmin}}>
                <div class="section-header page-list">
                    <paper-button class="save-button" raised on-tap="expandPages">Show all pages
                        <iron-icon icon$="[[expand]]"></iron-icon>
                    </paper-button>
                    <div class="sub-align"><span>Published</span>
                        <paper-toggle-button checked="{{published}}"></paper-toggle-button>
                    </div>
                    <div class="sub-align"><span>Trash</span>
                        <paper-toggle-button checked="{{trash}}"></paper-toggle-button>
                    </div>
                    <a href="/new/page" title="Create a page">
                        <paper-icon-button class="" icon="add"></paper-icon-button>
                    </a>
                </div>
                <iron-collapse id="collapse" opened="{{opened}}">
                    <div class="material app-grid">
                        <template is="dom-repeat" items={{pages}} as=item index-as=index>
                            <a class="page-card" href="/page/[[item.slug]]">
                                <div class="material" elevation="1">
                                    <h2>[[_ucfirst(item.title)]]</h2>
                                </div>
                            </a>
                        </template>
                    </div>
                    <template is="dom-if" if={{!pages.length}}>
                        <h2>Oops ¯\_(ツ)_/¯, no page found!</h2>
                    </template>
                </iron-collapse>
            </template>
            <template is="dom-if" if={{editMode}}>
                <div class="section-header">
                    <paper-input label="Titre de la page" value="{{_page.title}}"></paper-input>
                    <div class="sub-align"><span>Publish</span>
                        <paper-toggle-button checked="{{_page.published}}"></paper-toggle-button>
                    </div>
                    <paper-button class="save-button" raised on-tap="updatePage">
                        <iron-icon icon="done"></iron-icon>Save</paper-button>
                </div>
                <div class="section-header">
                    <paper-input style="width: 90%;" id="articleTitle" label="Link to the page" value="{{_page.slug}}">
                        <div prefix><span>[[origin]]/</span></div>
                    </paper-input>
                </div>
            </template>
            <iron-pages selected="{{_page.mode}}" attr-for-selected="name" fallback-section="text">
                <section name="text">
                    <polymer-mce hidden$="[[!editMode]]" id="editor" base-url="[[origin]]/bower_components/tinymce" tinytoolbar="insertfile undo redo | styleselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image"
                        tinyplugins='["advlist autolink lists link image charmap print preview anchor","searchreplace visualblocks code fullscreen","insertdatetime media table contextmenu paste"]'></polymer-mce>
                </section>
                <section name="grid">
                    <template is="dom-if" if={{isAdmin}}>
                        <div class="section-header">
                            <div>Column number : {{nbCol}} <paper-slider value="{{nbCol}}" min="5" max="12"></paper-slider></div>
                            <div>
                                <paper-menu-button>
                                  <paper-button class="save-button" raised slot="dropdown-trigger"><iron-icon icon="add"></iron-icon>ADD</paper-button>
                                  <paper-listbox slot="dropdown-content">
                                    <paper-item><paper-button on-tap="addTextTile"><iron-icon icon="editor:text-fields"></iron-icon>Text</paper-button></paper-item>
                                    <paper-item><paper-button on-tap="addImageTile"><iron-icon icon="editor:insert-photo"></iron-icon>Image</paper-button></paper-item>
                                  </paper-listbox>
                                </paper-menu-button>
                            </div>
                        </div>
                    </template>
                    <the-grid
                        id="grid"
                        draggable=[[editMode]]
                        resizable=[[editMode]]
                        animated
                        row-autogrow=[[editMode]]
                        col-count="{{nbCol}}"
                        row-count="{{nbRow}}"
                        cell-width="{{cellWidth}}"
                        cell-height="{{cellHeight}}"
                        cell-margin="0">

                        <template is="dom-repeat" items={{_page.content}}
                            as=tile index-as=index initialCount=2>
                            <page-tile class="tile"
                                edit$="[[editMode]]"
                                tile="{{tile}}"
                                type="{{tile.type}}"
                                col$="{{tile.col}}"
                                row$="{{tile.row}}"
                                height$="{{tile.height}}"
                                width$="{{tile.width}}"
                                content="{{tile.content}}"
                                index="[[index]]"
                                on-move="_handleMove"
                                on-resize="_handleMove"
                                on-delete-tile="handleDeleteTile">

                                <span resize="left"></span>
                                <span resize="right"></span>
                                <span resize="top"></span>
                                <span resize="bottom"></span>
                                <span resize="top-right"></span>
                                <span resize="top-left"></span>
                                <span resize="bottom-right"></span>
                                <span resize="bottom-left"></span>
                            </page-tile>
                        </template>
                        <div placeholder></div>
                    </the-grid>
                </section>
            </iron-pages>
            <div class="material" id="content"></div>
        </div>
        <paper-toast id="stateMessage" horizontal-align="left" always-on-top duration="5000" text="" on-iron-overlay-closed="_toastClosed">
            <iron-icon id="toastIcon" class="validate-icon" icon$="[[stateMessageIcon]]"></iron-icon>
        </paper-toast>
    </template>
    <script>
        Polymer({
            is: 'everest-page-page',

            properties: {
                route: {
                    type: Object,
                },

                page: {
                    type: Object,
                },

                rights: {
                    type: Object,
                },

                isAdmin: {
                    type: Boolean,
                    value: false,
                },

                rights: Number,

                editMode: {
                    type: Boolean,
                    value: false,
                },

                user: {
                    type: Object,
                    notify: true,
                },

                published: {
                    type: String,
                    value: true,
                },

                trash: {
                    type: Boolean,
                    value: false
                },

                opened: {
                    type: Boolean,
                    observer: '_openedChanged',
                },

                expand: {
                    type: String,
                    value: "expand-more",
                },

                origin: {
                    type: String,
                },


                nbCol: {
                    type: Number,
                    value: 12,
                    obsever: '_computeCellWidth'
                },

                nbRow: {
                    type: Number,
                    value: 6
                },

                cellHeight: {
                    type: Number,
                    value: 100
                },

                cellWidth: {
                    type: Number,
                    value: 100
                },

                stateMessageIcon: {
                    type: String,
                    value: "check-circle"
                },

                stateMessage: {
                    type: Object,
                    value: function () {
                        return {
                            'success': {
                                icon: "check-circle",
                                text: "Your changes have been saved!",
                            },
                            'errorExist': {
                                icon: "warning",
                                text: "Error! A page with this title already exists!",
                            },
                            'errorEmpty': {
                                icon: "warning",
                                text: "Error! You must give a title to your page!",
                            },
                            'errorCategory': {
                                icon: "warning",
                                text: "Error! You must assign a category to your article!",
                            },
                            'errorRight': {
                                icon: "warning",
                                text: "Error! You do not have the rights!",
                            },
                        }
                    }
                },
            },

            observers: [
                '_computeCombinedIndex(published, trash)',
                '_pageChanged(page.content)',
                '_rightsChanged(rights.ts)',
            ],

            ready: function () {
                this.origin = window.location.origin;

                // Init the compute of the grid
                this._computeCellWidth();

                window.addEventListener('resize', this._computeCellWidth.bind(this));
            },

            edit: function (e) {
                this.editMode = true;
            },

            close: function (e) {
                this.editMode = false;
            },


            addTextTile: function (e) {
                if (this.pageTiles.length >= this.nbRow-2) {
                    ++this.nbRow;
                }
                this.push('pageTiles', {
                    type: 'text',
                    col: 0,
                    row: this.pageTiles.length,
                    height: 1,
                    width: this.nbCol,
                    content: {}
                });
            },

            addImageTile: function (e) {
                if (this.pageTiles.length >= this.nbRow-2) {
                    ++this.nbRow;
                }
                this.push('pageTiles', {
                    type: 'image',
                    col: 0,
                    row: this.pageTiles.length,
                    height: 1,
                    width: this.nbCol,
                    content: {}
                });
            },

            updatePage: function () {
                if (this._page.title && this.$.editor.getContent() != "") {
                    var _this = this;
                    let ref = window.horizon("pages");
                    ref.upsert({
                        id: this.page.id,
                        slug: getSlug(this.page.slug),
                        title: this.page.title,
                        content: this.$.editor.getContent() || "",
                        created: this.page.created,
                        edited: Date.now(),
                        author: this.page.author,
                        authorID: this.page.authorID,
                        published: this.page.published,
                        trash: false
                    }).subscribe((value) => {
                        _this.stateMessageIcon = _this.stateMessage.success.icon;
                        _this.$.stateMessage.text = _this.stateMessage.success.text;
                        _this.$.stateMessage.open();
                        _this.isUpdate = true;
                    }, err => {
                        _this.stateMessageIcon = _this.stateMessage.errorExist.icon;
                        _this.$.stateMessage.text = _this.stateMessage.errorExist.text;
                        _this.$.stateMessage.open();
                    });
                }
            },

            _pageChanged: function (content) {
                this._page = this.page;
                if (this.page && this.page.mode == "text") {
                    this.$.content.innerHTML = content || '';
                }

                if (typeof content != 'undefined') {
                    if (this.pastSlug == null) {
                        this.pastSlug = this.page.slug;
                    }
                    this.date = moment(this.page.edited).fromNow();
                    if (this.page.mode == "text") {
                        this.$.editor.setContent(this.page.content);
                    }
                }
            },

            _computeCombinedIndex: function (published, trash) {
                this.combinedFilters = this.published + "~" + this.trash;
            },

            _computeCombinedIndexPt: function () {
                return this.page.published
                    + "~" + "false";
            },

            _computeCombinedIndexSp: function () {
                return this.page.slug
                    + "~" + this.page.published;
            },

            expandPages: function () {
                this.$$('#collapse').toggle();
            },

            _openedChanged: function (opened) {
                this.expand = "expand-more";
                if (opened) {
                    this.expand = "expand-less";
                }
            },

            _toastClosed: function (e) {
                if (this.isUpdate) {
                    this.editMode = false;
                    if (this.pastSlug != this.page.slug) {
                        window.history.pushState({}, null,
                            '/page/' + this.page.slug);
                        this.pastSlug = null;
                    }
                }
            },


            _computeCellWidth: function () {
                let initWidth = window.innerWidth - (2*24 + 2* 16);
                this.cellHeight = (window.innerHeight - 12 * ( this.nbRow - 1)) / this.nbRow;
                this.cellWidth = (initWidth - 12 * ( this.nbCol - 1)) / this.nbCol;
            },

            /**
             * Handle any tile move and save it new props
             *
             * @param      {Event}  event   the move event object
             */
            _handleMove: function (event) {
                // let idx = event.detail.tile.index;
                // if (this.menus[idx]) {
                //     if (event.detail.tile.col)
                //         this.menus[idx].col = event.detail.tile.col;

                //     if (event.detail.tile.row)
                //         this.menus[idx].row = event.detail.tile.row;

                //     if (event.detail.tile.height)
                //         this.menus[idx].height = event.detail.tile.height;

                //     if (event.detail.tile.width)
                //         this.menus[idx].width = event.detail.tile.width;
                // }
            },

            checkRights: function (role) {
                if (this.rights == 4) {
                    this.isAdmin = true;
                } else {
                    this.isAdmin = false;
                }
            },

            _rightsChanged: function (ts) {
                this.checkRights('administrators');
            },

            _ucfirst: function (string) {
                if (string) {
                    return string.charAt(0).toUpperCase() + string.slice(1);
                }
                return '';
            },
        });
    </script>
</dom-module>